---
title: "Aquaculture and stability"
author: "Richard Cottrell"
date: "24 June 2019"
output: html_document
---
#LIBRARIES
```{r}
library(grid)
library(purrr)
library(png)
library(zoo)
library(Hmisc)
library(mgcv)
library(data.table)
library(tidyverse)
library(ggpubr)
library(ggsci)
library(countrycode)
library(RColorBrewer)
library(rvest)
library(stringr)
library(magrittr)
library(ggrepel)
library(viridis)
library(boot)
library(Kendall)
```

#Plot of consumption versus GDP
```{r} 

(food_bal_total <- fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
   filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
   filter(Area %in% unique(Area)[1:183]) %>%
   filter(!Area %in% c("China, Hong Kong SAR", "China, mainland",  "China, Macao SAR", "China, Taiwan Province of")) %>% 
  filter(Year>2010) %>% 
   filter(`Item Code`!= 2948) %>% 
   filter(Item %in% c("Cereals - Excluding Beer", "Fruits - Excluding Wine", "Pulses", "Vegetables","Vegetable Oils", "Spices", "Starchy Roots" , "Aquatic Plants",  "Offals, Edible", "Meat", "Fish, Seafood", "Milk - Excluding Butter", "Eggs", "Miscellaneous")) %>% 
  group_by(Area, Year) %>% 
  summarise(Value=sum(Value)) %>% 
  group_by(Area) %>% 
  summarise(Total=mean(Value)) %>% 
  arrange(-Total) %>% 
  mutate(iso_a3=countrycode(Area, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
  select(-Area))


(pop <- fread("Population.csv", header=TRUE) %>% 
    rename(Country = `Country Name`) %>% 
    select(-c(`Indicator Name`, `Indicator Code`, `Country Code`, V64)) %>%
    mutate(iso_a3 = countrycode(Country, origin="country.name", destination="iso3c", warn=TRUE))%>% 
    drop_na(iso_a3) %>% 
    gather(key="Year", value="Population", -c(Country, iso_a3))%>% 
    mutate_if(bit64::is.integer64, as.integer) %>% 
    filter(Year %in% c(2011, 2012, 2013)) %>% 
    drop_na(Population) %>% 
    arrange(-Population)
)
  

(gdp <- fread("GDP_US_2010.csv", header=TRUE) %>% 
    rename(Country = `Country Name`) %>% 
    select(-c(`Indicator Name`, `Indicator Code`, `Country Code`)) %>%
    mutate(iso_a3 = countrycode(Country, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    drop_na(iso_a3) %>% 
    gather(key="Year", value="GDP", -c(Country, iso_a3)) %>% 
    filter(Year %in% c(2011, 2012, 2013)) %>% 
    drop_na(GDP) %>% 
    arrange(Country) %>% 
    left_join(pop, by=c("iso_a3", "Country", "Year")) %>%
    mutate(GDP_per_cap = GDP/Population) %>% 
    group_by(Country, iso_a3) %>% 
    summarise(GDP_per_cap = mean(GDP_per_cap)) %>% 
    arrange(-GDP_per_cap)
  
)


food_bal_seafood <- fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
    filter(Area %in% unique(Area)[1:183]) %>%
    filter(!Area %in% c("China, Hong Kong SAR", "China, mainland", "China, Macao SAR", "China, Taiwan Province of")) %>% 
    filter(Year==2013) %>% 
    filter(`Item Code`!= 2948) %>% 
    filter(Item %in% c("Fish, Seafood")) %>% 
    group_by(Area, Year) %>% 
    summarise(Value=sum(Value)) %>% 
    group_by(Area) %>% 
    summarise(Seafood=mean(Value)) %>% 
    arrange(-Seafood) %>% 
    mutate(iso_a3=countrycode(Area, origin="country.name", destination="iso3c", warn=TRUE))



(food_bal_animal <- fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
    filter(Area %in% unique(Area)[1:183]) %>%
    filter(!Area %in% c("China, Hong Kong SAR", "China, mainland", "China, Macao SAR", "China, Taiwan Province of")) %>% 
    filter(Year==2013) %>% 
    filter(`Item Code`!= 2948) %>% 
    filter(Item %in% c( "Meat", "Fish, Seafood")) %>% 
    group_by(Area, Year) %>% 
    summarise(Value=sum(Value)) %>% 
    group_by(Area) %>% 
    summarise(Value=mean(Value)) %>% 
    arrange(-Value) %>% 
    mutate(iso_a3=countrycode(Area, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    left_join(gdp, by="iso_a3") %>% 
    drop_na() %>% 
    left_join(food_bal_seafood, by=c("Area", "iso_a3")) %>% 
    left_join(food_bal_total, by="iso_a3") %>% 
    mutate(Prop_total_food = Seafood/Total) %>% 
    distinct()
  
  )


labels <- food_bal_animal %>% 
  filter(Area %in% c("Australia", "Maldives", "Iceland","Samoa", "United States of America")) %>% 
  mutate(Area = case_when(Area == "United States of America"~"USA",
                          TRUE ~ Area))

  
consumption_gdp <- 
  ggplot(food_bal_animal, aes(x=(GDP_per_cap), y=Value))+
  geom_point(aes(colour=Prop_total_food), size=1)+
  theme_pubr()+
  theme(
    text=element_text(size=5), 
    legend.text = element_text(size=5),
    legend.title = element_text(size=5),
    legend.position = c(0.18,0.8),
    #legend.direction = "horizontal",
    legend.box.spacing = unit(-0.05, "cm"),
    legend.background = element_rect(fill="transparent"),
    plot.margin = unit(c(t=0.5, r=0.1, b=0.1, l=0.1), "cm")
  )+
  labs(y=bquote(Meat~"&"~fish~consumption~(kg~capita^-1~yr^-1)), x=bquote(GDP~capita^-1~(USD~2010~equivalents)))+
  scale_x_log10(breaks = c(1000, 10000, 100000), labels=c("1000", "10000", "100000"))+
  scale_color_gradient2(low = "black", mid="lightblue", midpoint = 0.12, high="dodgerblue")+
  geom_line(aes(y=predict(glm(Value~log10(GDP_per_cap), family="quasipoisson"), type="response"))) + 
  geom_text(data=labels, mapping = aes(x=GDP_per_cap, y=Value, label=Area), segment.color = "grey50", point.padding = NA, size=1.5, nudge_x = c(0.1, 0.1,0.1,-0.05,0.1), nudge_y = c(10, 10,10, 10, -14))+
  annotate("segment", x=6e+4, xend = 5e+4, y=128, yend = 136, colour="grey50")+
  guides(colour = guide_colorbar(barwidth = 0.3, barheight = 3, units="cm", ticks = FALSE, title = "Prop. of total food\nsupply from seafood", title.position = "top", title.hjust = 0))#+
  
  # ggsave("Meat_fish_consumption.tiff", device="tiff", dpi=600, width=8, height=6, units="cm")+
  # ggsave("Meat_fish_consumption.pdf", device="pdf", dpi=600, width=8, height=6, units="cm")
  # 
  
summary(glm(consumption_gdp$data$Value~(consumption_gdp$data$GDP_per_cap), family = "quasipoisson"))


    
exp((1.446e-05*10000))

(unique(gdp$Year))
```


#Share of fish in animal supply
```{r}

#Share of fish in food supply


(food_bal_australia <- 
   bind_rows(
     fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
       filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
       filter(Area == c("Australia")) %>% 
       filter(`Item Code`!= 2948) %>% 
       filter(Item %in% c("Meat", "Fish, Seafood", "Cereals - Excluding Beer", "Milk - Excluding Butter", "Eggs", "Fruits - Excluding Wine", "Pulses", "Vegetables", "Starchy Roots")) %>% 
       mutate(Item = case_when(Item == "Cereals - Excluding Beer" ~ "Cereals", 
                               Item == "Milk - Excluding Butter" ~ "Milk", 
                               Item %in% c("Fruits - Excluding Wine", "Pulses", "Vegetables", "Starchy Roots")~ "Fruit, Vegetables", 
                               TRUE ~ Item)) %>% 
       group_by(Item, Year) %>%
       summarise(Value=sum(Value)) %>% 
       ungroup() %>% 
       group_by(Item) %>% 
       nest() %>% 
       mutate(Relative_value = map(data, ~(.$Value/.$Value[1]))) %>% 
       unnest(),
     
     fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
       filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
       filter(Area == c("Australia")) %>% 
       filter(`Item Code`!= 2948) %>% 
       filter(Item %in% c("Cereals - Excluding Beer", "Fruits - Excluding Wine", "Pulses", "Vegetables","Vegetable Oils", "Spices", "Starchy Roots" , "Aquatic Plants",  "Offals, Edible", "Meat", "Fish, Seafood", "Milk - Excluding Butter", "Eggs", "Miscellaneous")) %>% 
       mutate(Item="Total food") %>% 
       drop_na(Value) %>% 
       group_by(Year, Item) %>% 
       summarise(Value=sum(Value)) %>% 
       ungroup() %>% 
       group_by(Item) %>% 
       nest() %>% 
       mutate(Relative_value = map(data, ~(.$Value/.$Value[1]))) %>% 
       unnest()
     
     
   )
)



consumption_items <- ggplot(food_bal_australia %>% 
         mutate(Item = factor(Item, levels=c("Fish, Seafood", "Fruit, Vegetables",  "Meat", "Milk", "Cereals", "Eggs", "Total food"))), aes(x=Year, y=Relative_value, colour=Item))+
  geom_line(size=0.9)+
  scale_color_manual(values = rev(c("#D53E4F", "#FC8D59" ,"#FEE08B", "goldenrod", "#E6F598", "#99D594", "#3288BD")))+
  theme_pubr()+
  scale_x_continuous(limits=c(1960,2020))+
  theme(
    legend.position = c(0.2,0.8),
    legend.title = element_blank(),
    legend.text = element_text(size=7),
    legend.key.height = unit(0.2, "cm"),
    text = element_text(size=9)
  )+
  labs(y="Relative consumption")+
  ggsave("Figure 1a - relative consumption.tiff", dpi=600, device = "tiff", width=9, height=7, units="cm")



(seafood <- 
  fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
       filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
       filter(Area == c("Australia")) %>% 
       filter(`Item Code`!= 2948) %>% 
       filter(Item %in% c( "Fish, Seafood")) %>% 
    select(Item, Year, Value) %>% 
    rename(Seafood=Value)
)


(animal <- 
  fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
       filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
       filter(Area == c("Australia")) %>% 
       filter(`Item Code`!= 2948) %>% 
       filter(Item %in% c( "Meat", "Fish, Seafood", "Milk - Excluding Butter", "Eggs")) %>% 
    select(Item, Year, Value) %>% 
    group_by(Year) %>% 
    summarise(Animal=sum(Value))
)

(animal_no_milk <- 
  fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
       filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
       filter(Area == c("Australia")) %>% 
       filter(`Item Code`!= 2948) %>% 
       filter(Item %in% c( "Meat", "Fish, Seafood", "Aquatic Plants", "Eggs")) %>% 
    select(Item, Year, Value) %>% 
    group_by(Year) %>% 
    summarise(Animal_no_milk=sum(Value))
)


(Total <- 
  fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
       filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
       filter(Area == c("Australia")) %>% 
       filter(`Item Code`!= 2948) %>% 
       filter(Item %in% c("Cereals - Excluding Beer", "Fruits - Excluding Wine", "Pulses", "Vegetables","Vegetable Oils", "Spices", "Starchy Roots" , "Aquatic Plants",  "Offals, Edible", "Meat", "Fish, Seafood", "Milk - Excluding Butter", "Eggs", "Miscellaneous")) %>% 
    select(Item, Year, Value) %>% 
    group_by(Year) %>% 
    summarise(Total=sum(Value))
)



(proportions <- 
  seafood %>% 
  left_join(animal, by="Year") %>% 
  left_join(animal_no_milk, by="Year") %>% 
    left_join(Total, by="Year") %>% 
    mutate(prop_total=Seafood/Animal) %>% 
    mutate(prop_no_milk = Seafood/Animal_no_milk) %>% 
    mutate(prop_total = Seafood/Total)
)



proportions2 <- 
  bind_rows(
  proportions %>% 
  select(Year, Seafood, prop_total) %>% 
  rename(Value=prop_total) %>% 
  mutate(Item="Incl. Milk"),
  
  proportions %>% 
  select(Year, Seafood, prop_no_milk) %>% 
  rename(Value=prop_no_milk) %>% 
  mutate(Item = "Excl. Milk")
  
)



prop_seafood <- ggplot(proportions2 %>% 
                         filter(Year %in% c(1973, 1993, 2013)) %>% 
                         mutate(Year = factor(Year)), 
                       aes(x=Year, y=Value, fill=Item))+
  geom_bar(stat = "identity", position = "dodge")+
  #geom_line(size=0.9)+
  scale_fill_manual(values = rev(c("grey70", "#3288BD")))+
  theme_pubr()+
  #scale_x_continuous(limits=c(1960,2020))+
  theme(
    legend.position = c(0.15,0.9),
    legend.title = element_blank(),
    legend.text = element_text(size=7),
    legend.key.height = unit(0.3, "cm"),
    text = element_text(size=9)
  )+
  labs(y="Prop. animal consumption from seafood")+
  ggsave("Figure 1b - proportions.tiff", device="tiff", dpi=600, width=9, height=7, units="cm")








fish_img <- readPNG("tuna1.png")
fish_img <- rasterGrob(fish_img)

(production <- 
   bind_rows(
     fisheries <- 
       fread("fisheries_prod_raw.csv", header=TRUE) %>%
       rename(Country = `Country (Country)`,
              Species = `Species (ASFIS species)`,
              Fishing_area = `Fishing area (FAO major fishing area)`,
              Unit=`Unit (Unit)`) %>% 
       gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
       mutate(Year = as.numeric(Year)) %>% 
       mutate(Value = case_when(Value=="0 0" ~ "0.2",
                                Value=="-" ~ "NA",
                                Value == "..." ~ "NA",
                                Value ==" " ~ "NA",
                                TRUE ~ Value)) %>% 
       filter(Country=="Australia") %>%
       filter(Unit == "Tonnes - live weight") %>% 
       mutate(Value = gsub(" F", "", Value) %>% 
                as.numeric()) %>% 
       drop_na(Value) %>% 
       filter(Year %in% c(1960:2017)) %>%
       #filter(!Species %in% c("Salps", "Hard corals, madrepores nei" )) %>% 
       group_by(Year) %>%
       summarise(Value = sum(Value)) %>% 
       mutate(Element="Capture fisheries"),
     
     aquaculture <- 
       fread("aqua-prod-raw.csv", header=TRUE) %>%
       rename(Country = `Country (Country)`,
              Species = `Species (ASFIS species)`,
              Farming_area = `Aquaculture area (FAO major fishing area)`,
              Environment = `Environment (Environment)`) %>% 
       gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
       mutate(Year = as.numeric(Year)) %>% 
       mutate(Value = case_when(Value=="0 0" ~ "0.2",
                                Value=="-" ~ "NA",
                                Value == "..." ~ "NA",
                                Value ==" " ~ "NA",
                                TRUE ~ Value)) %>% 
       filter(Country=="Australia") %>%
       #filter(Species =="Atlantic salmon") %>% 
       #filter(!grepl("Inland waters", Farming_area)) %>% 
       filter(Unit == "Tonnes - live weight") %>% 
       mutate(Value = gsub(" F", "", Value) %>% 
                as.numeric()) %>% 
       filter(Year >1959) %>% 
       drop_na() %>% 
       group_by(Year) %>% 
       summarise(Value=sum(Value)) %>% 
       mutate(Element="Aquaculture")
   ) %>%
   mutate(Element= factor(Element, levels=c("Capture fisheries", "Aquaculture"))) %>%
   group_by(Element) %>% 
   nest() %>% 
   mutate(GAM = purrr::map(data, ~(predict(gam(.$Value~s(.$Year)))))) %>% 
   unnest() %>% 
   mutate(GAM = case_when(Element=="Aquaculture" ~ NA_real_,
                          TRUE ~ GAM)) %>% 
   ggplot(aes(x=Year, y=Value, colour=Element))+
   geom_line(size=0.9)+
   #geom_line(aes(y=GAM, group=Element), colour="grey50", size=0.25)+
   theme_pubr()+
   theme(
     text = element_text(size=9),
     legend.background = element_rect(fill="transparent"),
     legend.position = c(0.22,0.9),
     legend.direction = "vertical",
     legend.box.spacing = unit(0,"cm"),
     #legend.key.width = unit(0.4, "cm"),
     legend.key.height = unit(0.3,"cm"),
     legend.title = element_blank(),
     legend.text = element_text(size=7),
     legend.spacing = unit(-0.3, "cm")
   )+
   scale_color_manual(values=c("dodgerblue", "dodgerblue4")) + 
   labs(y=bquote(Domestic~production~("1000s"~tonnes)))+
   scale_y_continuous(labels = c("0", "50","100","150", "200", "250"), breaks = c(0, 5e+4,10e+4,15e+4, 20e+4, 25e+4), limits = c(0,27.5e+4))+
   scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1960,2020))+
   #annotate("text", x=1967, y=27.5e+4, label="Fisheries/Seafood", hjust=0, size=2)+
    #annotation_custom(fish_img, xmin = 1958,xmax = 1967, ymin = 25.7e+4, ymax=29.1e+4)+
   ggsave("Figure 1c - domestic produdction.tiff", dpi=600, device = "tiff", width=9, height = 7, units = "cm")
)



(pop <- fread("Population.csv", header=TRUE) %>% 
   rename(Country = `Country Name`) %>% 
   select(-c(`Indicator Name`, `Indicator Code`, `Country Code`, V64)) %>%
   mutate(iso_a3 = countrycode(Country, origin="country.name", destination="iso3c", warn=TRUE))%>% 
   drop_na(iso_a3) %>% 
   gather(key="Year", value="Population", -c(Country, iso_a3))%>% 
   mutate_if(bit64::is.integer64, as.integer) %>% 
   filter(Country=="Australia") %>% 
   mutate(Year=as.integer(Year))
)

(seafood_demand_supply <- 
    bind_rows(
      
      
      fisheries <- 
       fread("fisheries_prod_raw.csv", header=TRUE) %>%
       rename(Country = `Country (Country)`,
              Species = `Species (ASFIS species)`,
              Fishing_area = `Fishing area (FAO major fishing area)`,
              Unit=`Unit (Unit)`) %>% 
       gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
       mutate(Year = as.numeric(Year)) %>% 
       mutate(Value = case_when(Value=="0 0" ~ "0.2",
                                Value=="-" ~ "NA",
                                Value == "..." ~ "NA",
                                Value ==" " ~ "NA",
                                TRUE ~ Value)) %>% 
       filter(Country=="Australia") %>%
       filter(Unit == "Tonnes - live weight") %>% 
       mutate(Value = gsub(" F", "", Value) %>% 
                as.numeric()) %>% 
       drop_na(Value) %>% 
       filter(Year %in% c(1960:2017)) %>%
       #filter(!Species %in% c("Salps", "Hard corals, madrepores nei" )) %>% 
       group_by(Year) %>%
       summarise(Value = sum(Value)) %>% 
       mutate(Element="Fisheries landings"),
      
      aquaculture <- 
       fread("aqua-prod-raw.csv", header=TRUE) %>%
       rename(Country = `Country (Country)`,
              Species = `Species (ASFIS species)`,
              Farming_area = `Aquaculture area (FAO major fishing area)`,
              Environment = `Environment (Environment)`) %>% 
       gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
       mutate(Year = as.numeric(Year)) %>% 
       mutate(Value = case_when(Value=="0 0" ~ "0.2",
                                Value=="-" ~ "NA",
                                Value == "..." ~ "NA",
                                Value ==" " ~ "NA",
                                TRUE ~ Value)) %>% 
       filter(Country=="Australia") %>%
       #filter(Species =="Atlantic salmon") %>% 
       #filter(!grepl("Inland waters", Farming_area)) %>% 
       filter(Unit == "Tonnes - live weight") %>% 
       mutate(Value = gsub(" F", "", Value) %>% 
                as.numeric()) %>% 
       filter(Year >1959) %>% 
       drop_na() %>% 
       group_by(Year) %>% 
       summarise(Value=sum(Value)) %>% 
       mutate(Element="Aquaculture production"),
      
      
      
      aqua_fish_combo <- 
        bind_cols(fisheries %>% 
                    rename(Fisheries = Value), 
                  aquaculture %>% 
                    select(Value, Element) %>% 
                    rename(Aquaculture=Value)
        ) %>%   
        mutate(Value=Fisheries+Aquaculture) %>% 
        select(Year, Value) %>% 
        mutate(Element = "Total seafood production"),
      
      fish_consumption <- fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
        filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
        filter(Area == c("Australia")) %>% 
        filter(`Item Code`!= 2948) %>% 
        filter(Item %in% c("Fish, Seafood")) %>% 
        select(Year, Value) %>% 
        rename(Supply=Value) %>% 
        left_join(pop, by="Year") %>% 
        mutate(Value = (Supply*Population)/1000) %>% 
        select(Year, Value) %>% 
        mutate(Element="Domestic seafood consumption")
    ) %>% 
    mutate(Element = factor(Element, levels=c("Domestic seafood consumption", "Total seafood production", "Fisheries landings", "Aquaculture production"))) %>% 
    ggplot(aes(Year, Value, colour=Element, linetype=Element))+
    geom_line(size=0.9)+
    theme_pubr()+
    theme(
      text = element_text(size=9),
      legend.background = element_rect(fill="transparent"),
      #axis.title.y = element_blank(),
      legend.position = c(0.3,0.9),
      legend.direction = "vertical",
      legend.box.spacing = unit(0,"cm"),
      #legend.key.width = unit(0.4, "cm"),
      legend.key.height = unit(0.3,"cm"),
      legend.title = element_blank(),
      legend.text = element_text(size=7),
      legend.spacing = unit(-0.3, "cm"),
      plot.margin = unit(c(t=0.5, r=4.5, b=0.5, l=4.5), "cm")
    )+
    labs(y="Seafood biomass (1000s tonnes)")+
    scale_color_manual(values = c("black", "grey60", "dodgerblue3", "dodgerblue"))+
    scale_linetype_manual(values=c(1,1,1,1))+
    scale_y_continuous(labels = c("0", "200","400","600"), breaks = c(0, 2e+5,4e+5,6e+5), limits = c(0,6.1e+5))+
    scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1960,2020))+
    annotate("segment",x=2013, xend=2013, y=260e+3, yend=590e+3,  arrow=arrow(length = unit(1.5, "mm"),  ends = "both", type = "open"), size=0.45, colour="grey50")+
    annotate("text", x=2019, y=410e+3, label="354 217 \nMT",size=2)+
    ggsave("Production_seafood.tiff", dpi=600, device = "tiff", width=18, height = 7, units = "cm")
)





ggarrange(ggarrange(consumption_items, prop_seafood,
          labels=c("a", "b"),
          nrow = 1,
          ncol=2,
          label.x = c(0,-0.05)
          #font.label = list(size=8)
          ),
          seafood_demand_supply, 
          nrow = 2, 
          ncol=1,
          labels=c("", "c"),
          label.x = c(0, 0.18)
          )+
  ggsave("Figure - consumption trends.tiff", device="tiff", dpi=600, width = 18, height = 14, units = "cm")+
  ggsave("Figure - consumption trends.pdf", device="pdf", dpi=600, width = 18, height = 14, units = "cm")



```



#EWS for fisheries
```{r}
window <- 0.5

(fisheries <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country=="Australia") %>%
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na(Value) %>% 
    # mutate(Value = case_when(is.na(Value)~0,
    #                          TRUE ~ Value)) %>% 
    # filter(!grepl("Inland waters", Fishing_area)) %>% 
    # left_join(spp, by="Species") %>% 
    # rename(Group = ISSCAAP_Group) %>%
    # select(Year, Country, Group, Value) %>% 
    group_by(Year) %>% 
    summarise(Value=sum(Value)) %>%
    mutate(Normalized_value = (Value - mean(Value))/sd(Value)) %>% 
    mutate(Element="Fisheries") %>% 
    mutate(Residuals = resid(gam(Value~s(Year)))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width = window*length(Residuals), 
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Mean = rollapply(data = Residuals, 
                            width = window*length(Residuals), 
                            FUN = mean, 
                            align = "right", 
                            fill = NA, 
                            na.rm = T)) %>%
    mutate(CV=Variance/Mean) %>%
    mutate(AR1 = rollapply(data = Residuals, 
                           width = window*length(Residuals), 
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                   width= window*length(Residuals),
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Kurtosis = rollapply(data=Residuals,
                                   width=window*length(Residuals),
                                   FUN = moments::kurtosis,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                   width=0.5*length(Residuals),
                                   FUN = moments::skewness,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T))
)


#fishing boat png 

fishing_img <- readPNG("fishingboat.png")
fishing_img <- rasterGrob(fishing_img)



(landings <- ggplot(fisheries,
       aes(x=Year)) +
  geom_line(aes(y=Value), colour="#3288BD", size=1.1)+
  geom_line(aes(y=predict(gam(Value~s(Year)))), size=0.6, colour="grey60")+
    theme_pubr()+
    theme(
      text = element_text(size=9),
      axis.title.x = element_blank()
      #plot.margin = unit(c(t=0.5, r=0.1,b=0.1,l=0.1), "cm")
      
      
    )+
    geom_vline(xintercept = 2005, linetype=2, colour="grey80", size=0.75)+
    scale_y_continuous(breaks = c(0 ,0.5e+5, 1e+5, 1.5e+5,2e+5, 2.5e+5), labels=c("0", "50", "100", "150", "200", "250"), limits = c(0, 2.7e+5))+
    scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1950,2020))+
    labs(y=bquote(Fisheries~landings~(Tx10^3)))+
    #annotation_custom(fishing_img, xmin = 1950, 1960, ymin = 1.9e+5, ymax=2.9e+5)+
    #annotate("text", x=1960, y=2.4e+5,label="Fisheries\nlandings", hjust=0, size=1.8)+
    ggsave("EWS_landings.tiff", dpi=600, device="tiff", width = 5.5, height=4, units = "cm")

)


variance_ts <- fisheries$Variance[!is.na(fisheries$Variance)]

(variance_tau <- Kendall(1:length(variance_ts), variance_ts)$tau[1])

tau.fc<-function(x,y){
   y<-sample(x, replace = T)
  tau<-as.numeric(Kendall(1:length(y), y)$tau)
  return(tau)
}

boot_mod <- boot(data=variance_ts, statistic=tau.fc,  R=1000)
hist(boot$t, xlim = c(-1, 1))
abline(v=variance_tau, lty=2, col="red")
length(which(boot$t>variance_tau))/1000





(Variance <- ggplot(fisheries,
       aes(x=Year)) +
  geom_line(aes(y=Variance), colour="black", size=0.9)+
    theme_pubr()+
    theme(
      text = element_text(size=9),
      axis.title.x = element_blank()
    )+
    geom_vline(xintercept = 2005, linetype=2, colour="grey80", size=0.75)+
    scale_y_continuous(breaks = c(8e+3 ,10e+3, 12e+3, 14e+3,16e+3), labels=c("8", "10", "12", "14", "16"))+
    scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1950,2020))+
    labs(y=bquote(Variance~(Tx10^3)))+
    annotate("segment", x=1950, xend=1982, y=8e+3, yend=8e+3, size=0.7, lineend = "butt", arrow=arrow(length = unit(1.8, "mm"), ends = "both", type = "open"))+
    annotate("text", x=1966, y=9e+3, label="Rolling window", size=3)+
    geom_text(x=1966, y=15e+3, label="tau~'= 0.815, p=0'", parse=TRUE, size=3)+
    ggsave("EWS_variance.tiff", dpi=600, device="tiff", width = 5.5, height=4, units = "cm")

)


(AR1_ts <- fisheries$AR1[!is.na(fisheries$AR1)])

(AR1_tau <- Kendall(1:length(AR1_ts), AR1_ts)$tau[1])


boot_mod <- boot(data=AR1_ts, statistic=tau.fc,  R=1000)
hist(boot$t, xlim = c(-1, 1))
abline(v=AR1_tau, lty=2, col="red")
length(which(boot$t>AR1_tau))/1000




(AR1 <- ggplot(fisheries,
       aes(x=Year)) +
  geom_line(aes(y=AR1), colour="black", size=0.9)+
    theme_pubr()+
    geom_vline(xintercept = 2005, linetype=2, colour="grey80", size=0.75)+
    theme(
      text = element_text(size=9)
    )+
    #scale_y_continuous(breaks = c(0 ,0.5e+5, 1e+5, 1.5e+5,2e+5, 2.5e+5), labels=c("0", "50", "100", "150", "200", "250"), limits = c(0, 2.55e+5))+
    scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1950,2020))+
    labs(y="AR1", x="Year")+
    annotate("segment", x=1950, xend=1982, y=0.05, yend=0.05, size=0.7, lineend = "butt", arrow=arrow(length = unit(1.8, "mm"), ends = "both", type = "open"))+
    annotate("text", x=1966, y=0.1, label="Rolling window", size=3)+
    annotate("text", x=1966, y=0.4, label="tau~'= 0.778, p=0'",, parse=TRUE, size=3)+
    ggsave("EWS_AR1.tiff", dpi=600, device="tiff", width = 5.5, height=4, units = "cm")


)

length(fisheries$Residuals)*window


ggarrange(landings, Variance, AR1, 
         nrow=3, ncol=1,
         heights = c(1.6,1,1.15),
         labels = c("a", "b", "c"),
         font.label = list(size=9),
         label.y = c(1, 1.1, 1),
         align = "v")+
  ggsave("Figure - EWS.tiff", device = "tiff", dpi=600, width = 9, height = 13, units = "cm")+
  ggsave("Figure - EWS.pdf", device = "pdf", dpi=600, width = 9, height = 13, units = "cm")






```




#Production and perceptions
```{r}
(top_spp <- fread("aqua-prod-raw.csv", header=TRUE) %>%
  rename(Country = `Country (Country)`,
         Species = `Species (ASFIS species)`,
         Farming_area = `Aquaculture area (FAO major fishing area)`,
         Environment = `Environment (Environment)`) %>% 
  gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
  mutate(Year = as.numeric(Year)) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "NA",
                           Value == "..." ~ "NA",
                           Value ==" " ~ "NA",
                           TRUE ~ Value)) %>% 
  filter(Country=="Australia") %>%
  #filter(Species =="Atlantic salmon") %>% 
  #filter(!grepl("Inland waters", Farming_area)) %>% 
  filter(Unit == "Tonnes - live weight") %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric()) %>% 
  filter(Year >2016) %>% 
  drop_na() %>% 
  group_by(Species) %>% 
  summarise(Value=sum(Value)) %>% 
  arrange(-Value) %>% 
  slice(1:10)
)


aus_aqua <- fread("aqua-prod-raw.csv", header=TRUE) %>%
  rename(Country = `Country (Country)`,
         Species = `Species (ASFIS species)`,
         Farming_area = `Aquaculture area (FAO major fishing area)`,
         Environment = `Environment (Environment)`) %>% 
  gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
  mutate(Year = as.numeric(Year)) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "NA",
                           Value == "..." ~ "NA",
                           Value ==" " ~ "NA",
                           TRUE ~ Value)) %>% 
  filter(Country=="Australia") %>%
  #filter(Species =="Atlantic salmon") %>% 
  #filter(!grepl("Inland waters", Farming_area)) %>% 
  filter(Unit == "Tonnes - live weight") %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric()) %>% 
  filter(Species %in% top_spp$Species) %>%
  filter(Year %in% c(1967, 1977, 1987, 1997, 2007, 2017)) %>% 
  mutate(Year = factor(Year)) %>% 
  drop_na(Value) %>% 
  group_by(Species, Year) %>% 
  summarise(Value=sum(Value)) %>% 
  ggplot(aes(x=Year, y=Value, fill=Species))+
  geom_bar(stat="identity")+
  theme_pubr()+
  theme(
    text = element_text(size = 10),
    legend.text = element_text(size=6),
    legend.position = c(0.4, 0.85),
    legend.key.size = unit(0.3, "cm"),
    legend.title = element_blank(),
    legend.background = element_rect(fill = "transparent")
  )+
  scale_fill_manual(values=brewer.pal(n=10, name = "Spectral"))+
  labs(y="Biomass (thousand tonnes)")+
  scale_y_continuous(breaks=c(0,25000, 50000, 75000, 100000), labels=c("0", "25", "50", "75", "100"))+
  guides(fill = guide_legend(byrow = TRUE, nrow = 5, ncol=2))+
  ggsave("Australian aquaculture.tiff", device="tiff", dpi=300, width=8.9, height=8, units = "cm")


(ranks_aqua <- 
  fread("Headlines - aquaculture_AF.csv", header=TRUE) %>% 
    mutate(Consensus = as.character(Consensus)) %>% 
    mutate(Consensus = case_when(AGREEMENT == "TRUE" ~ Sentiment_1,
                                TRUE ~ Consensus)) %>%
  mutate(Sentiment_total = case_when(Consensus == -1 ~ "Negative",
                                     Consensus == 0 ~ "Neutral",
                                     Consensus == 1 ~ "Positive")) %>%
    filter(!is.na(Consensus)) %>% 
  
  group_by(State) %>% 
  
  count(Sentiment_total) %>% 
  group_by(State) %>% 
  mutate(Prop = prop.table(n)) %>% 
  ungroup() %>% 
  mutate(Sentiment_total = factor(Sentiment_total, levels=c("Positive", "Neutral", "Negative"))) %>% 
  mutate(State = case_when(State == "Australian Capital Territory" ~ "ACT",
                           State == "Western Australia" ~ "WA",
                           State == "Victoria" ~ "VIC",
                           State == "New South Wales" ~ "NSW",
                           State== "Tasmania" ~ "TAS",
                           State == "Northern Territory" ~ "NT",
                           State=="South Australia" ~ "SA",
                           State == "Queensland" ~ "QLD")) %>% 
  filter(Sentiment_total=="Negative") %>% 
  mutate(Rank = rank(-Prop)) %>% 
  select(State, Rank) %>% 
  add_row(State="NT", Rank=8)
  # add_row(State="QLD", Rank=8)
)


(aquaculture_sentiment <- 
  fread("Headlines - aquaculture_AF.csv", header=TRUE) %>% 
    mutate(Consensus = as.character(Consensus)) %>% 
    mutate(Consensus = case_when(AGREEMENT == "TRUE" ~ Sentiment_1,
                                TRUE ~ Consensus)) %>%
  filter(!is.na(Consensus)) %>% 
  mutate(Sentiment_total = case_when(Consensus == -1 ~ "Negative",
                                     Consensus == 0 ~ "Neutral",
                                     Consensus == 1 ~ "Positive")) %>% 
  group_by(State) %>% 
  
  count(Sentiment_total) %>% 
  group_by(State) %>% 
  mutate(Prop = prop.table(n)) %>% 
  ungroup() %>% 
  mutate(Sentiment_total = factor(Sentiment_total, levels=c("Positive", "Neutral", "Negative"))) %>% 
  mutate(State = case_when(State == "Australian Capital Territory" ~ "ACT",
                           State == "Western Australia" ~ "WA",
                           State == "Victoria" ~ "VIC",
                           State == "New South Wales" ~ "NSW",
                           State== "Tasmania" ~ "TAS",
                           State == "Northern Territory" ~ "NT",
                           State=="South Australia" ~ "SA",
                           State == "Queensland" ~ "QLD")) %>% 
  left_join(ranks_aqua, by="State") %>% 
  
  ggplot(aes(x=reorder(State, -Rank), y=Prop, fill=Sentiment_total))+
  geom_bar(stat="identity")+
  coord_flip()+
    theme_pubr()+
    theme(
      text = element_text(size=8),
      #axis.title = element_blank(),
      legend.spacing.x = unit(0.1, "cm"),
      legend.box.spacing = unit(0.05, "cm"),
      legend.position = "right",
      legend.title = element_blank(),
      legend.key.size = unit(0.35, "cm")
      #plot.margin = unit(c(t=0.2,r=1, b=0.2, l=0.2), "cm")
    )+
    labs(fill="Proportion of Sentiment", y="Proportion of sentiment", x="State/territory")+
    guides(fill=guide_legend(title.position = "bottom", title.hjust = 0.5))+
    scale_fill_manual(values = c("dodgerblue", "grey70", "firebrick"))+
    ggsave("Sentiment - aquaculture.tiff", device = "tiff", width = 4, height = 4, units = "cm")+
    ggsave("Sentiment - aquaculture.pdf", device = "pdf", width = 4, height = 4, units = "cm")
)



nimby <- fread("state_production.csv") %>% 
  ggplot(aes(x=Prop_prod, Prop_neg))+geom_point(size=3.2, colour="dodgerblue4")+
  theme_pubr()+
  theme(text = element_text(size=9))+
  geom_line(aes(y=predict(lm(Prop_neg~Prop_prod))), colour="grey", size=0.9)+
  geom_text_repel(aes(x=Prop_prod, y=Prop_neg, label=State), point.padding = 0.35, force = 1, max.iter = 1000,size=3)+
  labs(x="Prop. domestic aquaculture production", y="Prop. negative aquaculture sentiment")+
  ggsave("Sentiment and production.tiff", device = "tiff", width = 9, height = 7, units = "cm")


ggarrange(aquaculture_sentiment, nimby,
          nrow = 1, ncol=2,
          labels = c("a", "b"),
          font.label = list(size=9),
          widths = c(1,0.8), 
          label.x = c(0,-0.04))+
  ggsave("Figure - perceptions and production.tiff", device = "tiff", dpi=600, width = 18, height=7, units = "cm")
  

```



```{r}
(food_bal_australia <- 
   bind_rows(
     fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
       filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
       filter(Area == c("Australia")) %>% 
       filter(`Item Code`!= 2948) %>% 
       filter(Item %in% c("Meat", "Fish, Seafood")) %>% 
       group_by(Item) %>% 
       nest() %>% 
       mutate(Relative_value = map(data, ~(.$Value/.$Value[1]))) %>% 
       unnest(),
     
     fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
       filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
       filter(Area == c("Australia")) %>% 
       filter(`Item Code`!= 2948) %>% 
       filter(Item %in% c("Cereals - Excluding Beer", "Fruits - Excluding Wine", "Pulses", "Vegetables","Vegetable Oils", "Spices", "Starchy Roots" , "Aquatic Plants",  "Offals, Edible", "Meat", "Fish, Seafood", "Milk - Excluding Butter", "Eggs", "Miscellaneous")) %>% 
       mutate(Item="Total food") %>% 
       drop_na(Value) %>% 
       group_by(Year, Item) %>% 
       summarise(Value=sum(Value)) %>% 
       ungroup() %>% 
       group_by(Item) %>% 
       nest() %>% 
       mutate(Relative_value = map(data, ~(.$Value/.$Value[1]))) %>% 
       unnest()
     
     
   )
)




  trends <- ggplot(food_bal_australia, aes(x=Year, y=Relative_value, colour=Item))+
  geom_line(size=0.6)+
  theme_pubr()+
  scale_color_manual(values = c( "dodgerblue","grey20", "grey50")) +#"#440154FF" "#56C667FF"
  theme(
    text = element_text(size=5),
    legend.position= c(0.2,0.85),
    legend.title = element_blank(),
    legend.text = element_text(size=5),
    legend.key.size = unit(0.25, "cm"),
    legend.background = element_rect(fill="transparent")
  )+
  labs(y=bquote(Relative~consumption~capita^-1))+
  ggsave("Meat_vs_seafood_trends.tiff", device="tiff", dpi=600, width=8, height=6, units="cm")+
  ggsave("Meat_vs_seafood_trends.pdf", device="pdf", dpi=600, width=8, height=6, units="cm")



  (land_sea <- 
    fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
    filter(Area == c("Australia")) %>% 
    filter(`Item Code`!= 2948) %>% 
    filter(Item %in% c("Meat", "Fish, Seafood","Cereals - Excluding Beer", "Fruits - Excluding Wine", "Pulses", "Vegetables",  "Offals, Edible", "Vegetable Oils", "Sugar & Sweeteners")) %>% 
    mutate(Item = case_when(Item %in% c("Cereals - Excluding Beer", "Fruits - Excluding Wine", "Pulses", "Vegetables")~"Crops",
                            Item %in% c("Vegetable Oils") ~ "Oils, fats",
                            TRUE ~ Item)) %>% 
    group_by(Item, Year) %>% 
    summarise(Value = sum(Value)) %>% 
    ungroup() %>% 
    group_by(Item) %>% 
    nest() %>% 
    mutate(Relative_value = map(data, ~(.$Value/.$Value[1]))) %>% 
    unnest()
  )
  
  
unique(land_sea$Item)


```



#consumption, gdp and trends combined

```{r}


```


#frail food production systems

#CROPS
```{r}

### CROPS

# Cereals <- c("Barley", "Maize", "Maize, green", "Oats", "Rice, paddy", "Wheat", "Sorghum", "Rye", "Millet", "Grain, mixed", "Cereals, nes")
# 
# Vegetables <- c("Artichokes", "Asparagus", "Cabbages and other brassicas", "Lettuce and chicory", "Spinach", "Cucumbers and gherkins", "Eggplants (aubergines)", "Tomatoes",  "Watermelons", "Melons, other (inc.cantaloupes)", "Pumpkins, squash and gourds", "Carrots and turnips", "Garlic", "Onions, shallots, green", "Leeks, other alliaceous vegetables", "Mushrooms and truffles", "Okra", "Vegetables, leguminous nes", "Vegetables, fresh nes", "String beans")
# 
# 
# Fruits.Nuts<-c("Avocados", "Bananas", "Cranberries", "Plantains", "Dates", "Figs", "Mangoes, mangosteens, guavas", "Papayas", "Pineapples", "Grapefruit (inc. pomelos)",  "Lemons and limes", "Oranges", "Tangerines, mandarins, clementines, satsumas", "Grapes", "Berries nes", "Blueberries", "Gooseberries", "Kiwi fruit","Raspberries","Strawberries", "Apples","Apricots", "Cherries","Cherries, sour", "Peaches and nectarines", "Pears", "Quinces", "Plums and sloes", "Almonds, with shell", "Cashew nuts, with shell","Chestnut", "Hazelnuts, with shell", "Pistachios", "Walnuts, with shell", "Cashewapple", "Areca nuts", "Currants", "Nuts, nes", "Kola nuts", "Fruit, citrus nes", "Fruit, fresh nes",	"Fruit, pome nes"	,	"Fruit, stone nes", "Fruit, tropical fresh nes", "Brazil nuts, with shell", "Bambara beans" , "Karite nuts (sheanuts)")
# 
# Oil.crops <- c("Soybeans", "Groundnuts, with shell", "Castor oil seed", "Linseed", "Mustard seed", "Rapeseed" , "Safflower seed","Sesame seed", "Sunflower seed", "Oilseeds nes", "Coconuts" , "Olives", "Oil, palm fruit", "Oil, palm", "Palm kernels")
# 
# 
# Roots.Tubers <- c("Potatoes", "Sweet potatoes" , "Cassava", "Cassava leaves" , "Yams", "Yautia (cocoyam)", "Taro (cocoyam)", "Tung nuts", "Roots and tubers, nes")
# 
# Beverage.Spices <- c("Coffee, green", "Tea", "Mat\xe9", "Cocoa, beans", "Anise, badian, fennel, coriander", "Chillies and peppers, dry", "Chillies and peppers, green", "Pepper (piper spp.)", "Nutmeg, mace and cardamoms" , "Cinnamon (canella)","Cloves" , "Ginger", "Vanilla" , "Spices, nes")
# 
# Pulses <- c("Beans, dry", "Beans, green", "Broad beans, horse beans, dry", "Chick peas", "Lentils", "Lupins", "Peas, dry" , "Peas, green", "Pigeon peas", "Pulses, nes", "Cow peas, dry")
# 
# Sugar.crops <- c("Sugar beet", "Sugar cane", "Sugar crops, nes")
# 
# Fibres <- c("Agave fibres nes", "Bastfibres, other",  "Flax fibre and tow"  , "Kapok fibre", "Manila fibre (abaca)",  "Fibre crops nes",   "Jute & Jute-like Fibres", "Cotton lint" ,"Cottonseed", "Seed cotton", "Gums, natural", "Jute")


crop_img <- readPNG("crops.png")
crop_img <- rasterGrob(crop_img)


(crops <- 
   fread("Production_Crops_E_All_Data_(Normalized).csv", header=TRUE) %>% 
   filter(Element=="Production") %>%
   filter(Area %in% c("Australia")) %>% 
   filter(Item %in% unique(Item)[1:87])
 
)


(crops_plot <- 
  crops %>% 
  drop_na(Value) %>% 
  group_by(Year) %>% 
  summarise(Value=sum(Value)) %>%
  mutate(Element="Total crop\nproduction") %>% 
    ggplot(aes(x=Year, y=Value, colour=Element))+
    geom_line()+
    geom_line(aes(y=predict(gam(Value~s(Year)))), colour="grey50", size=0.25)+
    theme_pubr()+
    theme(
      text=element_text(size=6),
      legend.background = element_rect(fill="transparent"),
      legend.position = c(0.18,0.8),
      legend.direction = "vertical",
      legend.box.spacing = unit(0,"cm"),
      legend.key.width = unit(0.4, "cm"),
      legend.key.height = unit(0.1,"cm"),
      legend.title = element_blank(),
      legend.spacing = unit(-0.3, "cm")
    )+
    labs(y=bquote(Biomass~(million~tonnes)))+
    scale_colour_manual(values ="goldenrod")+ #"#DCE318FF"
    scale_y_continuous(labels = c(40,60,80,100), breaks = c(4e+7,6e+7,8e+7, 10e+7), limits = c(2.5e+7,11e+7))+
    scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1960,2020))+
    annotate("text", x=1967, y=11e+7, label="Crops", hjust=0, size=2)+
    annotation_custom(crop_img, xmin = 1958,xmax = 1966, ymin = 10.7e+7, ymax=11.3e+7)+
    ggsave("Production_crops.tiff", dpi=600, device = "tiff", width=5.5, height = 4, units = "cm")

)


(si_crops_plot_a <- 
  crops %>% 
  drop_na(Value) %>% 
  group_by(Year) %>% 
  summarise(Value=sum(Value)) %>% 
  mutate(Residuals = resid(gam(Value~s(Year)))) %>% 
  mutate(Variance = rollapply(data = Residuals, 
                                width = round(window*length(Residuals)), 
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(AR1 = rollapply(data = Residuals, 
                           width = round(window*length(Residuals)), 
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
  ggplot(aes(x=Year, y=Variance))+
    geom_line(colour="goldenrod")+
    theme_pubr()+
    theme(
      text = element_text(size=6)
    )+
    labs(y=bquote(Variance~(million~tonnes)))+
    scale_y_continuous(labels=c("4", "5", "6", "7", "8"), breaks=c(4e+6,5e+6,6e+6,7e+6,8e+6))+
    scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1960,2020))+
    geom_segment(x=1960, xend=1988, y=5e+6, yend=5e+6, lineend = "butt", arrow=arrow(length = unit(1.5, "mm"), ends = "both", type = "open"))+
    annotate("text", x=1974, y=5.3e+6, label="Rolling window",size=2)
  
)


top_crops <- crops %>% drop_na(Value) %>%  filter(Year==2017) %>% arrange(-Value)


(si_crops_plot_b <- 
  crops %>% 
  filter(Item %in% top_crops$Item[1:10]) %>% 
    mutate(Item = factor(Item, levels=c(top_crops$Item[1:10]))) %>% 
  ggplot(aes(x=Year, y=Value, colour=Item))+
    geom_line()+
    scale_color_manual(values=(viridis(10)))+
    scale_y_continuous(labels=c("0", "10", "20", "30", "40"), breaks=c(0,10e+6,20e+6,30e+6,40e+6))+
    scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1960,2020))+
    labs(y="Biomass (million tonnes)")+
    theme_pubr()+
    theme(
      text=element_text(size=6),
      legend.position = "right",
      legend.box.spacing = unit(0,"cm"),
      legend.key.size = unit(0.3, "cm"),
      legend.title = element_blank()
    )
)



ggarrange(si_crops_plot_a,
          si_crops_plot_b,
          labels = c("A", "B"),
          nrow = 1,
          ncol = 2,
          widths = c(1,1.4),
          font.label = list(size=7))+
  ggsave("Figure - SI crops.tiff", device="tiff", dpi=600, width=12, height=5, units = "cm")


unique(crops$Item)
```

#livestock industry

```{r}

(pop <- fread("Population.csv", header=TRUE) %>% 
   rename(Country = `Country Name`) %>% 
   select(-c(`Indicator Name`, `Indicator Code`, `Country Code`, V64)) %>%
   mutate(iso_a3 = countrycode(Country, origin="country.name", destination="iso3c", warn=TRUE))%>% 
   drop_na(iso_a3) %>% 
   gather(key="Year", value="Population", -c(Country, iso_a3))%>% 
   mutate_if(bit64::is.integer64, as.integer) %>% 
   filter(Country=="Australia") %>% 
   mutate(Year=as.integer(Year))
)




cow_img <- readPNG("cow.png")
cow_img <- rasterGrob(cow_img)

(livestock <- 
    bind_rows(
      meat <-
        fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
        filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
        filter(Area %in% c("Australia")) %>%
        filter(!Item %in% c("Meat, Total", "Milk,Total", "Eggs Primary", "Meat, Poultry", "Sheep and Goat Meat", "Beef and Buffalo Meat")) %>% #totals
        filter(!Item %in% "Milk, whole fresh cow") %>% 
        filter(!Item %in% c("Skins, sheep, with wool", "Wool, greasy", "Skins, goat, fresh" ,"Skins, sheep, fresh", "Beeswax", "Hides, cattle, fresh", "Honey, natural")) %>%    #non-food/meat items 
        group_by(Year) %>% 
        summarise(Value=sum(Value)) %>% 
        mutate(Element="Meat production") %>% 
        mutate(Line_type="Production") %>% 
        mutate(Feature = "Meat production"),
      
      
      milk <-
        fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
        filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
        filter(Area %in% c("Australia")) %>%
        #filter(!Item %in% c("Meat, Total", "Milk,Total", "Eggs Primary", "Meat, Poultry", "Sheep and Goat Meat", "Beef and Buffalo Meat")) %>% #totals
        filter(Item %in% c("Milk, whole fresh cow")) %>% 
        #filter(!Item %in% c("Skins, sheep, with wool", "Wool, greasy", "Skins, goat, fresh" ,"Skins, sheep, fresh", "Beeswax", "Hides, cattle, fresh", "Honey, natural", "Eggs, hen, in shell")) %>%    #non-food/meat items 
        group_by(Year) %>% 
        summarise(Value=sum(Value)) %>% 
        mutate(Element="Milk production") %>% 
        mutate(Line_type="Production") %>% 
        mutate(Feature = "Milk production"),
      
      
      
      meat_consumption <- fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
        filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
        filter(Area == c("Australia")) %>% 
        filter(`Item Code`!= 2948) %>% 
        filter(Item %in% c("Meat")) %>% 
        select(Year, Value) %>% 
        rename(Supply=Value) %>% 
        left_join(pop, by="Year") %>% 
        mutate(Value = (Supply*Population)/1000) %>% 
        select(Year, Value) %>% 
        mutate(Element="Meat consumption") %>% 
        mutate(Line_type="Demand") %>% 
        mutate(Feature = "Meat consumption")
      
      
    ) %>% 
    group_by(Feature) %>% 
    nest() %>% 
    mutate(GAM = purrr::map(data, ~(predict(gam(.$Value~s(.$Year)))))) %>% 
    unnest() %>% 
    mutate(GAM = case_when(Feature!="Milk production" ~ NA_real_,
                           TRUE ~ GAM)) %>% 
    mutate(Element = factor(Element, levels=c("Milk production", "Meat production", "Meat consumption"))) %>% 
    ggplot(aes(x=Year, y=Value, colour=Element))+
    geom_line(size=0.5)+
    geom_line(aes(y=GAM, group=Feature), colour="grey50", size=0.25)+
    scale_color_manual(values = c("grey70", "grey50", "grey30" ))+ #rev(c("#2A788EFF" ,"#22A884FF", "#7AD151FF"))
    #scale_linetype_manual(values = c(1,1))+
    theme_pubr()+
    theme(
      text=element_text(size=6),
      legend.background = element_rect(fill="transparent"),
      legend.position = c(0.22,0.765),
      legend.direction = "vertical",
      legend.box.spacing = unit(0,"cm"),
      legend.key.width = unit(0.4, "cm"),
      legend.key.height = unit(0.1,"cm"),
      legend.title = element_blank(),
      legend.spacing = unit(-0.3, "cm"),
      axis.title.y = element_blank(),
      plot.margin = unit(c(t=0.2, r=0.7, b=0.2, l=0.3), "cm")
    )+
    labs(y=bquote(Biomass~(million~tonnes)))+
    scale_y_continuous(labels = c("0", "3","6","9", "12"), breaks = c(0, 3e+6,6e+6,9e+6, 12e+6), limits = c(0,12.5e+6))+
    scale_x_continuous(breaks=c(1960,1980,2000,2020), labels = c("1960","1980","2000","2020"), limits = c(1960,2020))+
    guides(color = guide_legend(order = 1),linetype = FALSE)+
    annotate("text", x=1967, y=12.3e+6, label="Livestock", hjust=0, size=2)+
    annotation_custom(cow_img, xmin = 1958,xmax = 1967, ymin = 11.8e+6, ymax=12.8e+6)+
    
    ggsave("Production_livestock.tiff", dpi=600, device = "tiff", width=5.5, height = 4, units = "cm")
  
)





viridis(6)

```

#commercial fisheries + aquaculture

```{r}



```


#Supply and demand
```{r}





fish_consumption$Value[fish_consumption$Year==2013]-aqua_fish_combo$Value[aqua_fish_combo$Year==2013]


```


#Combining production trends
```{r}

ggarrange(crops_plot, livestock, seafood, seafood_demand_supply,
          labels = c("a", "b", "c", "d"),
          font.label = list(size=7))+
  ggsave("Figure - production trends.tiff", device="tiff", dpi=600, width = 12, height = 10, units="cm")+
  ggsave("Figure - production trends.pdf", device="pdf", dpi=600, width = 12, height = 10, units="cm")



```



#Breakdown of australian aquaculture
```{r}
(top_spp <- fread("aqua-prod-raw.csv", header=TRUE) %>%
  rename(Country = `Country (Country)`,
         Species = `Species (ASFIS species)`,
         Farming_area = `Aquaculture area (FAO major fishing area)`,
         Environment = `Environment (Environment)`) %>% 
  gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
  mutate(Year = as.numeric(Year)) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "NA",
                           Value == "..." ~ "NA",
                           Value ==" " ~ "NA",
                           TRUE ~ Value)) %>% 
  filter(Country=="Australia") %>%
  #filter(Species =="Atlantic salmon") %>% 
  #filter(!grepl("Inland waters", Farming_area)) %>% 
  filter(Unit == "Tonnes - live weight") %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric()) %>% 
  filter(Year >2016) %>% 
  drop_na() %>% 
  group_by(Species) %>% 
  summarise(Value=sum(Value)) %>% 
  arrange(-Value) %>% 
  slice(1:10)
)


fread("aqua-prod-raw.csv", header=TRUE) %>%
  rename(Country = `Country (Country)`,
         Species = `Species (ASFIS species)`,
         Farming_area = `Aquaculture area (FAO major fishing area)`,
         Environment = `Environment (Environment)`) %>% 
  gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
  mutate(Year = as.numeric(Year)) %>% 
  mutate(Value = case_when(Value=="0 0" ~ "0.2",
                           Value=="-" ~ "NA",
                           Value == "..." ~ "NA",
                           Value ==" " ~ "NA",
                           TRUE ~ Value)) %>% 
  filter(Country=="Australia") %>%
  #filter(Species =="Atlantic salmon") %>% 
  #filter(!grepl("Inland waters", Farming_area)) %>% 
  filter(Unit == "Tonnes - live weight") %>% 
  mutate(Value = gsub(" F", "", Value) %>% 
           as.numeric()) %>% 
  filter(Species %in% top_spp$Species) %>%
  filter(Year %in% c(1967, 1977, 1987, 1997, 2007, 2017)) %>% 
  mutate(Year = factor(Year)) %>% 
  drop_na(Value) %>% 
  group_by(Species, Year) %>% 
  summarise(Value=sum(Value)) %>% 
  ggplot(aes(x=Year, y=Value, fill=Species))+
  geom_bar(stat="identity")+
  theme_pubr()+
  theme(
    text = element_text(size = 10),
    legend.text = element_text(size=6),
    legend.position = c(0.4, 0.85),
    legend.key.size = unit(0.3, "cm"),
    legend.title = element_blank(),
    legend.background = element_rect(fill = "transparent")
  )+
  scale_fill_manual(values=brewer.pal(n=10, name = "Spectral"))+
  labs(y="Biomass (thousand tonnes)")+
  scale_y_continuous(breaks=c(0,25000, 50000, 75000, 100000), labels=c("0", "25", "50", "75", "100"))+
  guides(fill = guide_legend(byrow = TRUE, nrow = 5, ncol=2))+
  ggsave("Australian aquaculture.tiff", device="tiff", dpi=300, width=8.9, height=8, units = "cm")
 

```



#Import dependence
```{r}


(food_bal_total <- fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
   filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
   filter(Area %in% unique(Area)[1:183]) %>%
   filter(!Area %in% c("China, Hong Kong SAR", "China, mainland",  "China, Macao SAR", "China, Taiwan Province of")) %>% 
  filter(Year>2010) %>% 
   filter(`Item Code`!= 2948) %>% 
   filter(Item %in% c("Cereals - Excluding Beer", "Fruits - Excluding Wine", "Pulses", "Vegetables","Vegetable Oils", "Spices", "Starchy Roots" , "Aquatic Plants",  "Offals, Edible", "Meat", "Fish, Seafood", "Milk - Excluding Butter", "Eggs", "Miscellaneous")) %>% 
  group_by(Area, Year) %>% 
  summarise(Value=sum(Value)) %>% 
  group_by(Area) %>% 
  summarise(Total=mean(Value)) %>% 
  arrange(-Total) %>% 
  mutate(iso_a3=countrycode(Area, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
  select(-Area))


(food_bal_seafood <- fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Element %in% c("Food supply quantity (kg/capita/yr)")) %>% 
    filter(Area %in% unique(Area)[1:183]) %>%
    filter(!Area %in% c("China, Hong Kong SAR", "China, mainland", "China, Macao SAR", "China, Taiwan Province of")) %>% 
    filter(Year==2013) %>% 
    filter(`Item Code`!= 2948) %>% 
    filter(Item %in% c("Fish, Seafood")) %>% 
    group_by(Area, Year) %>% 
    summarise(Value=sum(Value)) %>% 
    group_by(Area) %>% 
    summarise(Seafood=mean(Value)) %>% 
    arrange(-Seafood) %>% 
    mutate(iso_a3=countrycode(Area, origin="country.name", destination="iso3c", warn=TRUE))
)


#progress towards SDG 14 data 
(SDG_scores <- 
  fread("SDG_scores.csv", header=TRUE)
)

(gsi_EIU <- 
  fread("gsi.csv", header=TRUE) %>% 
    mutate(iso_a3 = countrycode(country, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    select(-country)
)

#proportion of catch from IUU - doesn't really work

bind_rows(fread("NonIndustrial_watson.csv", header=TRUE), fread("Industrial-watson.csv", header=TRUE)) %>% 
  group_by(`FAO name`, IYear) %>% 
  summarise(Reported=sum(Reported), IUU = sum(IUU)) %>% 
  mutate(Prop_IUU = IUU/(IUU+Reported)) %>% 
  filter(IYear >2012) %>% 
  group_by(`FAO name`) %>% 
  summarise(Prop_IUU_mean = mean(Prop_IUU)) %>% 
  mutate(iso_a3 = countrycode(`FAO name`, origin="country.name", destination="iso3c", warn=TRUE))


(corruption <- 
    fread("corruption.csv", header=TRUE) %>% 
    gather(key="Year", value="CPI", -c(Country, iso_a3)) %>% 
    drop_na(CPI) %>% 
    group_by(iso_a3) %>% 
    summarise(CPI=mean(CPI))) 
  


#all seafood

(all_seafood_trade <- 
   bind_rows(
     fread("imports_reexports_fish_live.csv", header = TRUE),
     fread("imports_reimports_aquatic_inverts.csv", header = TRUE),
     fread("imports_reimports_crustaceans_live_1.csv", header = TRUE),
     fread("imports_reimports_crustaceans_live_2.csv", header = TRUE),
     fread("imports_reimports_fish_dried_1.csv", header = TRUE),
     fread("imports_reimports_fish_dried_2.csv", header = TRUE),
     fread("imports_reimports_fish_fillets_1.csv", header = TRUE),
     fread("imports_reimports_fish_fillets_2.csv", header = TRUE),
     fread("imports_reimports_fish_fillets_3.csv", header = TRUE),
     fread("imports_reimports_fish_fresh_1.csv", header = TRUE),
     fread("imports_reimports_fish_fresh_2.csv", header = TRUE),
     fread("imports_reimports_fish_fresh_3.csv", header = TRUE),
     fread("imports_reimports_fish_frozen_1.csv", header = TRUE),
     fread("imports_reimports_fish_frozen_2.csv", header = TRUE),
     fread("imports_reimports_fish_frozen_3.csv", header = TRUE),
     fread("imports_reimports_fish_frozen_4.csv", header = TRUE),
     fread("imports_reimports_molluscs_live_1.csv", header = TRUE),
     fread("imports_reimports_molluscs_live_2.csv", header = TRUE)
   ) %>% 
   filter(!Partner %in% c("World", "Australia")) %>% 
   rename(iso_a3 = `Partner ISO`, 
          Value=`Alt Qty Unit`,
          Value2=`Netweight (kg)`,
          Commodity_code = `Commodity Code`) %>% 
   select(Year, Partner, Commodity_code, Commodity, Value, Value2, Flag) %>% 
   filter(nchar(Commodity_code)==5) %>% 
   #filter(Year==2013) %>% 
   mutate(Value=Value/1000, Value2= Value2/1000) %>% 
   arrange(-Year) %>% 
   group_by(Partner, Commodity) %>% 
   summarise(Value = mean(Value)) %>% 
   group_by(Partner) %>% 
   summarise(Value=sum(Value)) %>% 
   arrange(-Value) %>% 
   mutate(Import_dependence = Value/sum(Value)*100) %>% 
   mutate(iso_a3 = countrycode(Partner, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
   mutate(iso_a3 = case_when(Partner == "Br. Virgin Isds" ~ "VGB",
                             Partner == "Curaao" ~ "CUW",
                             TRUE ~ iso_a3)) %>% 
    left_join(SDG_scores, by="iso_a3") %>% 
    left_join(corruption, by="iso_a3") %>% 
    left_join(gsi_EIU, by="iso_a3") %>% 
    select(Partner, Value, Import_dependence, iso_a3, SDG_14, CPI, gsi_prev, gsi_vuln, Illicit_trade) %>% 
    arrange(-Import_dependence) %>% 
    left_join(food_bal_seafood, by="iso_a3") %>%
    select(-Area) %>%
    left_join(food_bal_total, by="iso_a3") %>%
    mutate(Prop_seafood = Seafood/Total) %>%
    mutate(SDG_14_relative = SDG_14-54.96458) %>% 
    mutate(Illicit_inverse = 100-Illicit_trade) %>% 
    #mutate(CPI_relative = CPI-78.833333) %>% 
    mutate(Partner = case_when(Partner=="United Rep. of Tanzania" ~ "Tanzania",
                               TRUE ~ Partner))
)


sdg14 <- readPNG("SDG14.png")
sdg14 <- rasterGrob(sdg14)


ggplot(data=all_seafood_trade %>% slice(1:21) %>% drop_na(Seafood) , aes(x=reorder(Partner, -Import_dependence), y=Import_dependence))+
  geom_bar(aes(fill=SDG_14_relative), stat="identity")+
  theme_pubr()+
  theme(
    axis.text.x = element_text(angle=45, hjust = 1),
    text = element_text(size=9),
    legend.position = c(0.65,0.9),
    legend.direction = "horizontal",
    legend.background = element_rect(fill="transparent")
    )+

  scale_fill_gradient2(low="firebrick", mid = "grey90",  high="dodgerblue")+

  labs(y="Prop. seafood imports by weight (%)", x="Trade partner", fill="Progress towards SDG 14\nrelative to Australia")+
  guides(fill = guide_colorbar(ticks = FALSE, barheight = 1, barwidth = 5, units="cm",  title.hjust = 0.5))+
  annotation_custom(sdg14, xmin = 18, xmax = 20, ymin = 17, ymax = 21)+
  ggsave("Figure - progress toward SDG.tiff", device = "tiff", dpi=600, width = 12, height = 10, units = "cm")+
  ggsave("Figure - progress toward SDG.pdf", device = "pdf", dpi=600, width = 12, height = 10, units = "cm")



labels <- all_seafood_trade %>% slice(1:21) %>% drop_na(Seafood) %>% add_row(Partner= "", gsi_vuln=21.98, SDG_14 = 54.96458, Illicit_inverse = 19, Import_dependence = 0.1)


ggplot(data=all_seafood_trade %>% slice(1:21) %>% drop_na(Seafood) %>% 
         add_row(Partner= "", gsi_vuln=21.98, SDG_14 = 54.96458, Illicit_inverse = 19, Import_dependence = 2) %>% 
         mutate(shape = case_when(Partner=="" ~ "3",
                                  TRUE ~ "1")), 
       aes(x=gsi_vuln, y=SDG_14))+
  geom_point(aes(size=Import_dependence,colour=Illicit_inverse, shape=shape))+
  theme_bw()+
  theme(
    text = element_text(size=10),
    panel.grid = element_blank(),
    # legend.position = c(0.65,0.9),
    # legend.direction = "horizontal",
    legend.background = element_rect(fill="transparent")
    )+
  scale_colour_gradient(low="grey65",   high="firebrick", na.value = "black")+
  scale_size(range = c(1,12))+
  geom_vline(xintercept=21.98, linetype=2, colour="grey70")+
  geom_hline(yintercept=54.96458, linetype=2, colour="grey70")+
  geom_text_repel(data=labels, aes(x=gsi_vuln, y=SDG_14, label=Partner),point.padding = 0.62,force = 1, size=3.4, max.iter = 4000, vjust="inward")+
  labs(y="Progress towards SDG 14", x="Vulnerability to slavery", colour="Illicit trade risk", size="Prop. of seafood\nimports (%)")+
  guides(shape=FALSE)+
  #guides(fill = guide_colorbar(ticks = FALSE, barheight = 1, barwidth = 5, units="cm",  title.hjust = 0.5))+
  #annotation_custom(sdg14, xmin = 18, xmax = 20, ymin = 17, ymax = 21)+
  ggsave("Figure - import trade-offs.tiff", device = "tiff", dpi=600, width = 18, height = 13, units = "cm")+
  ggsave("Figure - import trade-offs.pdf", device = "pdf", dpi=600, width = 18, height = 13, units = "cm")


  



      ggplot(data=all_seafood_trade %>% slice(1:31), 
       aes(x=CPI_relative, y=SDG_14_relative))+
  geom_point(aes(size=Import_dependence)) + 
  geom_vline(xintercept=0, linetype=2, colour="grey70")+
  geom_hline(yintercept=0, linetype=2, colour="grey70")+
  theme_pubr()



all_seafood_trade


sum((all_seafood_trade %>% slice(1:21) %>% drop_na(Seafood))$Import_dependence)

```


#Sentiment analysis - aquaculture
```{r}
#LATEST SEARCH ACROSS ALL SECTORS 22/07/19


#search terms "(aquaculture OR fish farm) <STATE> Australia"


#tasmania
tasmania <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20tasmania%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  tasmania %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")


tas_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), 
                            State = "Tasmania", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              }))
                            )


#queensland

queensland <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20queensland%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  queensland %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

qld_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), 
                            State = "Queensland", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



#south australia

SA <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20south%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  SA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

SA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), 
                           State = "South Australia", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



#Western australia

WA <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20western%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  WA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

WA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), 
                           State = "Western Australia", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


#NSW


NSW <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20new%20south%20wales%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NSW_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), 
                            State = "New South Wales", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



VIC <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20victoria%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

VIC_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), 
                            State = "Victoria", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))




NT <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20northern%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), 
                           State = "Northern Territory", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


ACT <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20australian%20capital%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  ACT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

ACT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), 
                            State = "Australian Capital Territory", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


aquaculture_headlines <- 
  bind_rows(tas_headlines, qld_headlines, SA_headlines, VIC_headlines, NSW_headlines, NT_headlines, WA_headlines, ACT_headlines) %>% 
  mutate(System = "Aquaculture", Sentiment_1="", Sentiment_2="") %>% 
  select(System, State, Headline, Sentiment_1, Sentiment_2, Metadata) %>% 
  write_csv("Aquaculture headlines.csv")



```


#sentiment analysis - fisheries

```{r}

#search terms "(fisheries OR fishing) <STATE> Australia"



#tasmania
tasmania <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20tasmania%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  tasmania %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

tas_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Tasmania", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


queensland <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20queensland%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  queensland %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

qld_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Queensland", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



#south australia

SA <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20south%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  SA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

SA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "South Australia", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



#Western australia

WA <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20western%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  WA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

WA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Western Australia", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


#NSW


NSW <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20new%20south%20wales%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NSW_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "New South Wales", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



VIC <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20victoria%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

VIC_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Victoria", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))




NT <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20northern%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Northern Territory", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


ACT <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20australian%20capital%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  ACT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

ACT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Australian Capital Territory", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))




fisheries_headlines <- 
  bind_rows(tas_headlines, qld_headlines, SA_headlines, VIC_headlines, NSW_headlines, NT_headlines, WA_headlines, ACT_headlines) %>% 
  mutate(System = "Fisheries", Sentiment_1="", Sentiment_2="") %>% 
  select(System, State, Headline, Sentiment_1, Sentiment_2, Metadata) %>% 
  write_csv("Fisheries headlines.csv")



```


#sentiment analysis - agriculture
```{r}
#search terms "(agriculture) <STATE> Australia"



#tasmania
tasmania <- read_html("https://news.google.com/search?q=(agriculture)%20tasmania%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  tasmania %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

tas_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Tasmania", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))

queensland <- read_html("https://news.google.com/search?q=(agriculture)%20queensland%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  queensland %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

qld_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Queensland", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



#south australia

SA <- read_html("https://news.google.com/search?q=(agriculture)%20south%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  SA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

SA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "South Australia", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



#Western australia

WA <- read_html("https://news.google.com/search?q=(agriculture)%20western%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  WA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

WA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Western Australia", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


#NSW


NSW <- read_html("https://news.google.com/search?q=(agriculture)%20new%20south%20wales%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NSW_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "New South Wales", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))



VIC <- read_html("https://news.google.com/search?q=(agriculture)%20victoria%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

VIC_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Victoria", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))




NT <- read_html("https://news.google.com/search?q=(agriculture)%20northern%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Northern Territory", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


ACT <- read_html("https://news.google.com/search?q=(agriculture)%20australian%20capital%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  ACT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

ACT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Australian Capital Territory", 
                            Metadata= unlist(lapply(headlines, function(list_element){
                                length <- length(list_element)
                                metadata <- paste(list_element[2:length], collapse = "")
                                return(metadata)
                              })))


#quuensland



agriculture_headlines <- 
  bind_rows(tas_headlines, qld_headlines, SA_headlines, VIC_headlines, NSW_headlines, NT_headlines, WA_headlines, ACT_headlines) %>% 
  mutate(System = "Agriculture", Sentiment_1="", Sentiment_2="") %>% 
  select(System, State, Headline, Sentiment_1, Sentiment_2, Metadata) %>% 
  write_csv("Agriculture headlines.csv")


```

#Headlines analysis 
```{r}
(ranks_ag <- fread("Headlines_ag_AF.csv", header=TRUE) %>%
   mutate(Consensus = case_when(Agreement == "TRUE" ~ Sentiment_2,
                                TRUE ~ Consensus)) %>% 
  filter(!is.na(Consensus)) %>%
   mutate(State = case_when(State == "Australian Capital Territory" ~ "ACT",
                           State == "Western Australia" ~ "WA",
                           State == "Victoria" ~ "VIC",
                           State == "New South Wales" ~ "NSW",
                           State== "Tasmania" ~ "TAS",
                           State == "Northern Territory" ~ "NT",
                           State=="South Australia" ~ "SA",
                           State == "Queensland" ~ "QLD")) %>% 
  group_by(State) %>% 
   summarise(Sum = sum(Consensus))
)


(AG_sentiment <- 
    fread("Headlines_ag_AF.csv", header=TRUE) %>% 
    mutate(Consensus = case_when(Agreement == "TRUE" ~ Sentiment_2,
                                 TRUE ~ Consensus)) %>% 
    filter(!is.na(Consensus)) %>% 
    mutate(Sentiment_total = case_when(Consensus == -1 ~ "Negative",
                                       Consensus == 0 ~ "Neutral",
                                       Consensus == 1 ~ "Positive")) %>% 
    group_by(State) %>% 
    
    count(Sentiment_total) %>% 
    group_by(State) %>% 
    mutate(Prop = prop.table(n)) %>% 
    ungroup() %>% 
    mutate(Sentiment_total = factor(Sentiment_total, levels=c("Positive", "Neutral", "Negative"))) %>% 
    mutate(State = case_when(State == "Australian Capital Territory" ~ "ACT",
                             State == "Western Australia" ~ "WA",
                             State == "Victoria" ~ "VIC",
                             State == "New South Wales" ~ "NSW",
                             State== "Tasmania" ~ "TAS",
                             State == "Northern Territory" ~ "NT",
                             State=="South Australia" ~ "SA",
                             State == "Queensland" ~ "QLD")) %>% 
    left_join(ranks_ag, by="State") %>% 
    
    ggplot(aes(x=reorder(State, -Sum), y=Prop, fill=Sentiment_total))+
    geom_bar(stat="identity")+
    coord_flip()+
    theme_pubr()+
    theme(
      text = element_text(size=8),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      plot.margin = unit(c(t=0.2,r=0.7, b=0.2, l=0.2), "cm")
    )+
    labs(x="State")+
    guides(fill=FALSE)+
    scale_fill_manual(values = c("dodgerblue", "grey70", "firebrick"))+
    ggsave("Sentiment - Ag.tiff", device = "tiff", width = 4, height = 4, units = "cm")+
    ggsave("Sentiment - Ag.pdf", device = "pdf", width = 4, height = 4, units = "cm")
)


#fisheries


(ranks_fish <- 
    fread("Headlines - fisheries_AF.csv", header=TRUE) %>% 
     mutate(Consensus = case_when(Agreement == "TRUE" ~ Sentiment_2,
                                TRUE ~ Consensus)) %>% 
  filter(!is.na(Consensus)) %>% 
  mutate(Sentiment_total = case_when(Consensus == -1 ~ "Negative",
                                     Consensus == 0 ~ "Neutral",
                                     Consensus == 1 ~ "Positive")) %>% 
  group_by(State) %>% 
  
  count(Sentiment_total) %>% 
  group_by(State) %>% 
  mutate(Prop = prop.table(n)) %>% 
  ungroup() %>% 
  mutate(Sentiment_total = factor(Sentiment_total, levels=c("Positive", "Neutral", "Negative"))) %>% 
  mutate(State = case_when(State == "Australian Capital Territory" ~ "ACT",
                           State == "Western Australia" ~ "WA",
                           State == "Victoria" ~ "VIC",
                           State == "New South Wales" ~ "NSW",
                           State== "Tasmania" ~ "TAS",
                           State == "Northern Territory" ~ "NT",
                           State=="South Australia" ~ "SA",
                           State == "Queensland" ~ "QLD")) %>% 
  filter(Sentiment_total=="Negative") %>% 
  mutate(Rank = rank(-Prop)) %>% 
  select(State, Rank)
)


(fisheries_sentiment <- 
  fread("Headlines - fisheries_AF.csv", header=TRUE) %>% 
  mutate(Consensus = case_when(Agreement == "TRUE" ~ Sentiment_2,
                                TRUE ~ Consensus)) %>% 
  filter(!is.na(Consensus)) %>% 
  mutate(Sentiment_total = case_when(Consensus == -1 ~ "Negative",
                                     Consensus == 0 ~ "Neutral",
                                     Consensus == 1 ~ "Positive")) %>%
  group_by(State) %>% 
  
  count(Sentiment_total) %>% 
  group_by(State) %>% 
  mutate(Prop = prop.table(n)) %>% 
  ungroup() %>% 
  mutate(Sentiment_total = factor(Sentiment_total, levels=c("Positive", "Neutral", "Negative"))) %>% 
  mutate(State = case_when(State == "Australian Capital Territory" ~ "ACT",
                           State == "Western Australia" ~ "WA",
                           State == "Victoria" ~ "VIC",
                           State == "New South Wales" ~ "NSW",
                           State== "Tasmania" ~ "TAS",
                           State == "Northern Territory" ~ "NT",
                           State=="South Australia" ~ "SA",
                           State == "Queensland" ~ "QLD")) %>% 
  left_join(ranks_fish, by="State") %>% 
  
  ggplot(aes(x=reorder(State, -Rank), y=Prop, fill=Sentiment_total))+
  geom_bar(stat="identity")+
  coord_flip()+
    theme_pubr()+
    theme(
      text = element_text(size=8),
      legend.title = element_blank(),
      axis.title = element_blank(),
      plot.margin = unit(c(t=0.2,r=1.3, b=0.2, l=-0.1), "cm")
    )+
    guides(fill=FALSE)+
    scale_fill_manual(values = c("dodgerblue", "grey70", "firebrick"))+
    ggsave("Sentiment - fisheries.tiff", device = "tiff", width = 4, height = 4, units = "cm")+
    ggsave("Sentiment - fisheries.pdf", device = "pdf", width = 4, height = 4, units = "cm")
)




#aquaculture


(ranks_aqua <- 
  fread("Headlines - aquaculture_AF.csv", header=TRUE) %>% 
    mutate(Consensus = as.character(Consensus)) %>% 
    mutate(Consensus = case_when(AGREEMENT == "TRUE" ~ Sentiment_1,
                                TRUE ~ Consensus)) %>%
  mutate(Sentiment_total = case_when(Consensus == -1 ~ "Negative",
                                     Consensus == 0 ~ "Neutral",
                                     Consensus == 1 ~ "Positive")) %>%
    filter(!is.na(Consensus)) %>% 
  
  group_by(State) %>% 
  
  count(Sentiment_total) %>% 
  group_by(State) %>% 
  mutate(Prop = prop.table(n)) %>% 
  ungroup() %>% 
  mutate(Sentiment_total = factor(Sentiment_total, levels=c("Positive", "Neutral", "Negative"))) %>% 
  mutate(State = case_when(State == "Australian Capital Territory" ~ "ACT",
                           State == "Western Australia" ~ "WA",
                           State == "Victoria" ~ "VIC",
                           State == "New South Wales" ~ "NSW",
                           State== "Tasmania" ~ "TAS",
                           State == "Northern Territory" ~ "NT",
                           State=="South Australia" ~ "SA",
                           State == "Queensland" ~ "QLD")) %>% 
  filter(Sentiment_total=="Negative") %>% 
  mutate(Rank = rank(-Prop)) %>% 
  select(State, Rank) %>% 
  add_row(State="NT", Rank=8)
  # add_row(State="QLD", Rank=8)
)


(aquaculture_sentiment <- 
  fread("Headlines - aquaculture_AF.csv", header=TRUE) %>% 
    mutate(Consensus = as.character(Consensus)) %>% 
    mutate(Consensus = case_when(AGREEMENT == "TRUE" ~ Sentiment_1,
                                TRUE ~ Consensus)) %>%
  filter(!is.na(Consensus)) %>% 
  mutate(Sentiment_total = case_when(Consensus == -1 ~ "Negative",
                                     Consensus == 0 ~ "Neutral",
                                     Consensus == 1 ~ "Positive")) %>% 
  group_by(State) %>% 
  
  count(Sentiment_total) %>% 
  group_by(State) %>% 
  mutate(Prop = prop.table(n)) %>% 
  ungroup() %>% 
  mutate(Sentiment_total = factor(Sentiment_total, levels=c("Positive", "Neutral", "Negative"))) %>% 
  mutate(State = case_when(State == "Australian Capital Territory" ~ "ACT",
                           State == "Western Australia" ~ "WA",
                           State == "Victoria" ~ "VIC",
                           State == "New South Wales" ~ "NSW",
                           State== "Tasmania" ~ "TAS",
                           State == "Northern Territory" ~ "NT",
                           State=="South Australia" ~ "SA",
                           State == "Queensland" ~ "QLD")) %>% 
  left_join(ranks_aqua, by="State") %>% 
  
  ggplot(aes(x=reorder(State, -Rank), y=Prop, fill=Sentiment_total))+
  geom_bar(stat="identity")+
  coord_flip()+
    theme_pubr()+
    theme(
      text = element_text(size=8),
      axis.title = element_blank(),
      legend.spacing.x = unit(0.1, "cm"),
      legend.key.size = unit(0.35, "cm"),
      plot.margin = unit(c(t=0.2,r=1, b=0.2, l=0.2), "cm")
    )+
    labs(fill="Sentiment")+
    guides(fill=guide_legend(title.position = "bottom", title.hjust = 0.5))+
    scale_fill_manual(values = c("dodgerblue", "grey70", "firebrick"))+
    ggsave("Sentiment - aquaculture.tiff", device = "tiff", width = 4, height = 4, units = "cm")+
    ggsave("Sentiment - aquaculture.pdf", device = "pdf", width = 4, height = 4, units = "cm")
)

sentiment_legend <- get_legend(aquaculture_sentiment)

all_sentiment <- ggarrange(annotate_figure(
    ggarrange(AG_sentiment, aquaculture_sentiment, fisheries_sentiment,
              legend = FALSE,
              #labels=c("d", "e", "f"),
              font.label = list(size=9),
              label.x=c(0, -0.05, -0.07),
              nrow = 1,
              ncol = 3),
    bottom =  text_grob("Proportion of news headlines", size = 8)),
  sentiment_legend,
  nrow = 2,
  ncol=1,
  heights = c(1,0.3))+
  ggsave("Sentiment all.tiff", device = "tiff", width = 18, height = 7, units = "cm")+
  ggsave("Sentiment all.pdf", device = "pdf", width = 18, height = 7, units = "cm")


```

#Impacts across sectors from Hillborn et al 2018

```{r}
#PNG figures


cow <- readPNG("cow.png")
cow <- rasterGrob(cow)

pig <- readPNG("pig.png")
pig <- rasterGrob(pig)

hen <- readPNG("henedit.png")
hen <- rasterGrob(hen)

shrimp <- readPNG("shrimp.png")
shrimp <- rasterGrob(shrimp)

salmon <- readPNG("salmon.png")
salmon <- rasterGrob(salmon)

mollusc <- readPNG("oyster.png")
mollusc <- rasterGrob(mollusc)

lobster <- readPNG("lobster.png")
lobster <- rasterGrob(lobster)

flathead <- readPNG("flattie.png")
flathead <- rasterGrob(flathead)

tuna <- readPNG("tuna2.png")
tuna <- rasterGrob(tuna)

anchovy <- readPNG("anchovy.png")
anchovy <- rasterGrob(anchovy)

Impacts <- 
  fread("Impacts.csv", header=TRUE) %>% 
  group_by(Impact) %>% 
  nest() %>% 
  mutate(Normalised_impact = purrr::map(data, ~((.$Mean-min(.$Mean))/(max(.$Mean)-min(.$Mean))))) %>% 
  unnest()

(average_impact_AG <- 
    Impacts %>% 
    group_by(Sector, Source, Impact) %>% 
    summarise(Mean=mean(Normalised_impact)) %>% 
    ungroup() %>% 
    group_by(Sector, Source) %>% 
    summarise(Mean=sum(Mean)) %>% 
    ungroup() %>% 
    mutate(SD=NA, Impact="Combined") %>% 
    filter(Sector=="Agriculture") %>% 
    select(Source, Impact, Mean, SD) 
    
)



(average_impact_AQ <- 
    Impacts %>% 
    group_by(Sector, Source, Impact) %>% 
    summarise(Mean=mean(Normalised_impact)) %>% 
    ungroup() %>% 
    group_by(Sector, Source) %>% 
    summarise(Mean=sum(Mean)) %>% 
    ungroup() %>% 
    mutate(SD=NA, Impact="Combined") %>% 
    filter(Sector=="Aquaculture") %>% 
    select(Source, Impact, Mean, SD)
    
)


(average_impact_FISH <- 
    Impacts %>% 
    group_by(Sector, Source, Impact) %>% 
    summarise(Mean=mean(Normalised_impact)) %>% 
    ungroup() %>% 
    group_by(Sector, Source) %>% 
    summarise(Mean=sum(Mean)) %>% 
    ungroup() %>% 
    mutate(SD=NA, Impact="Combined") %>% 
    filter(Sector=="Fisheries") %>% 
    select(Source, Impact, Mean, SD)
    
)


(AG_impacts <- ggplot(data= bind_rows(Impacts %>% 
                         filter(Sector=="Agriculture") %>% 
                         group_by(Source, Impact) %>% 
                         summarise(Mean = mean(Normalised_impact), SD = sd(Normalised_impact)) %>% 
                         ungroup(),
                       average_impact_AG) %>% 
         mutate(Impact=factor(Impact, levels=c("GHG", "Energy use", "Acidification", "Eutrophication", "Combined")))%>% 
         mutate(Source = factor(Source, levels=c("Beef", "Pork", "Chicken"))),
       aes(x=Source, y=Mean, fill=Impact))+
  geom_bar(stat = "identity", position = "dodge")+
  geom_errorbar(aes(ymin=Mean-SD, ymax=Mean+SD), width=0.2, position = position_dodge(0.9), size=0.2)+
  scale_y_continuous(limits = c(-0.1,2), expand=c(0,0))+
  theme_pubr()+
    theme(
      text = element_text(size=8),
      plot.title = element_text(size=8, hjust=0.5, face="bold"),
      legend.title = element_blank(),
      axis.title.x = element_blank(),
      axis.text.x = element_text(angle=45, hjust=1),
      plot.margin = unit(c(t=0.4, r=-0.1, b=0.55, l=0.3), "cm")
    )+
    labs(y="Normalised impact", title="Agriculture")+
    guides(fill=FALSE)+
  scale_fill_manual(values = c("grey50", "goldenrod", "firebrick", "dodgerblue", "black"))+
    annotation_custom(cow, xmin=0.55, xmax=1.15, ymin=1.3, ymax=1.55)+
     annotation_custom(pig, xmin=1.65, xmax=2.15, ymin=0.7, ymax=0.95)+
    annotation_custom(hen, xmin=2.5, xmax=3.5, ymin=0.4, ymax=0.6)+

    ggsave("Impacts - agriculture.tiff", device = "tiff", width = 4, height = 5, units = "cm")+
    ggsave("Impacts - agriculture.pdf", device = "pdf", width = 4, height = 5, units = "cm")
)

(AQ_impacts <- 
    ggplot(data=bind_rows(Impacts %>% 
                            filter(Sector=="Aquaculture") %>% 
                            group_by(Source, Impact) %>% 
                            summarise(Mean = mean(Normalised_impact), SD = sd(Normalised_impact)) %>% 
                            ungroup(),
                          average_impact_AQ) %>% 
             mutate(Impact=factor(Impact, levels=c("GHG", "Energy use", "Acidification", "Eutrophication", "Combined")))%>% 
             mutate(Source=case_when(Source =="Farmed shrimp" ~ "Shrimp",
                                     TRUE~Source)) %>% 
             mutate(Source = factor(Source, levels=c("Shrimp", "Salmon", "Molluscs"))) %>% 
             mutate(Asterisk = case_when(Impact=="Combined" ~ "",
                                         is.na(SD)~ "*")),
           aes(x=Source, y=Mean, fill=Impact))+
    geom_bar(stat = "identity", position = "dodge")+
    geom_errorbar(aes(ymin=Mean-SD, ymax=Mean+SD), width=0.2, position = position_dodge(0.9), size=0.2)+
    geom_text(aes(label=Asterisk, y=Mean+0.05),position = position_dodge(0.9), size=2)+
    scale_y_continuous(limits = c(-0.1,2), expand=c(0,0))+
    theme_pubr()+theme(
      text = element_text(size=8),
      legend.title = element_blank(),
      axis.title = element_blank(),
      plot.title = element_text(size=8, hjust=0.5, face="bold"),
      axis.text.x = element_text(angle=45, hjust=1),
      plot.margin = unit(c(t=0.4, r=-0.2, b=0.55, l=0.25), "cm")
    )+
    labs(y="Normalised impact", title="Aquaculture")+
    guides(fill=FALSE)+
    scale_fill_manual(values = c("grey50", "goldenrod", "firebrick", "dodgerblue", "black"))+
    annotation_custom(shrimp, xmin=0.5, xmax=1, ymin=1, ymax=1.3)+
     annotation_custom(salmon, xmin=1.6, xmax=2.2, ymin=0.4, ymax=0.65)+
    annotation_custom(mollusc, xmin=2.7, xmax=3.1, ymin=0.25, ymax=0.4)+

    ggsave("Impacts - aquaculture.tiff", device = "tiff", width = 4, height = 5, units = "cm")+
    ggsave("Impacts - aquaculture.pdf", device = "pdf", width = 4, height = 5, units = "cm")
)

(FISH_impacts <- 
    ggplot(data=bind_rows(Impacts %>% 
                            filter(Sector=="Fisheries") %>% 
                            group_by(Source, Impact) %>% 
                            summarise(Mean = mean(Normalised_impact), SD = sd(Normalised_impact)) %>% 
                            ungroup(),
                          average_impact_FISH) %>% 
             mutate(Impact=factor(Impact, levels=c("GHG", "Energy use", "Acidification", "Eutrophication", "Combined")))%>% 
             mutate(Source=case_when(Source =="Wild shrimp" ~ "Shrimp",
                                     Source=="Invertebrates"~"Inverts",
                                     TRUE ~ Source)) %>%
             mutate(Source = factor(Source, levels=c("Inverts", "Shrimp", "White fish", "Large pelagic", "Small pelagic"))) %>% 
             mutate(Asterisk = case_when(Impact=="Combined" ~ "",
                                         is.na(SD)~ "*")),
           aes(x=Source, y=Mean, fill=Impact))+
    geom_bar(stat = "identity", position = "dodge")+
    geom_errorbar(aes(ymin=Mean-SD, ymax=Mean+SD), width=0.2, position = position_dodge(0.9), size=0.2)+
    geom_text(aes(label=Asterisk, y=Mean+0.05),position = position_dodge(0.9), size=2)+
    scale_y_continuous(limits = c(-0.1,2), expand=c(0,0))+
    theme_pubr()+
    theme(
      text = element_text(size=8),
      plot.title = element_text(size=8, hjust=0.5, face="bold"),
      legend.title = element_blank(),
      legend.key.size = unit(0.35, "cm"),
      legend.background = element_rect(fill="transparent"),
      legend.position = c(0.8, 0.65),
      axis.title = element_blank(),
      axis.text.x = element_text(angle=45, hjust=1),
      plot.margin = unit(c(t=0.4, r=0.2, b=0.2, l=0.2), "cm")
    )+
    labs(y="Normalised impact", title="Fisheries")+
    annotation_custom(lobster, xmin=0.6, xmax=1.2, ymin=1.6, ymax=1.9)+
    annotation_custom(shrimp, xmin=1.6, xmax=2.2, ymin=0.9, ymax=1.2)+
    annotation_custom(flathead, xmin=2.6, xmax=3.2, ymin=0.15, ymax=0.5)+
    annotation_custom(tuna, xmin=3.5, xmax=4.3, ymin=0.1, ymax=0.5)+
    annotation_custom(anchovy, xmin=4.6, xmax=5.2, ymin=0.05, ymax=0.3)+
    scale_fill_manual(values = c("grey50", "goldenrod", "firebrick", "dodgerblue", "black"))+
    ggsave("Impacts - fisheries.tiff", device = "tiff", width = 5, height = 5, units = "cm")+
    ggsave("Impacts - fisheries.pdf", device = "pdf", width = 5, height = 5, units = "cm")
)

#impacts_legend <- get_legend(FISH_impacts)

impacts_all <-
  ggarrange(AG_impacts, AQ_impacts, FISH_impacts,
          widths = c(1, 1, 1.2),
          #labels=c("a", "b", "c"),
          font.label = list(size=9),
          align = "v",
          nrow = 1,
          ncol = 3)+
  ggsave("Impacts - all.tiff", device = "tiff", width = 18, height = 7, units = "cm")+
  ggsave("Impacts - all.pdf", device = "pdf", width = 18, height = 7, units = "cm")


```

#Combining sentiment and impacts

```{r}

ggarrange(impacts_all, all_sentiment,
          labels = c("a", "b"),
          font.label = list(size=9),
          nrow = 2,
          ncol = 1, 
          heights = c(1.15,1))+
  ggsave("Figure - Impacts and sentiment.tiff", device="tiff", dpi=600, width=18, height = 12, units = "cm")+
  ggsave("Figure - Impacts and sentiment.pdf", device="pdf", dpi=600, width=18, height = 12, units = "cm")


```

#EWS-crops
```{r}
window <- 0.5

(crops <- 
    fread("Production_Crops_E_All_Data_(Normalized).csv", header=TRUE) %>% 
    filter(Element=="Production") %>%
    filter(Area %in% c("Australia")) %>% 
    filter(Item %in% unique(Item)[1:87]) %>% 
    filter(Item!= "Sugar cane") %>%  
    drop_na(Value) %>% 
    group_by(Year) %>% 
    summarise(Value=sum(Value)) %>% 
  mutate(Normalized_value = (Value -mean(Value))/sd(Value)) %>% 
    mutate(Element="Crops") %>% 
    mutate(Residuals = resid(gam(Value~s(Year)))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width = round(window*length(Residuals)), 
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(AR1 = rollapply(data = Residuals, 
                           width = round(window*length(Residuals)), 
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                   width= round(window*length(Residuals)), 
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Kurtosis = rollapply(data=Residuals,
                                width= round(window*length(Residuals)), 
                                FUN = moments::kurtosis,
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                width= round(window*length(Residuals)), 
                                FUN = moments::skewness,
                                align = "right", 
                                fill = NA, 
                                na.rm = T))
)




ggplot(crops, 
       aes(x=Year))+
  geom_line(aes(y=Return_rate))+
    #annotate("segment", ymin=-Inf, ymax = Inf, xmin = 2002, xmax = 2003, alpha=0.5)
  geom_vline(xintercept = 2003, linetype=2)+theme_pubr()


  cor(x=crops$Year[28:57], y=crops$Return_rate[28:57], method = "kendall")

unique(crops$Item)

crops %>% 
  filter(Year==2000) %>% 
  arrange(-Value) %>% 
  filter(!(Item %in% c("Cereals (Rice Milled Eqv)"))) %>% 
  filter(!grepl("Total", Item)) %>% 
  select(-c(`Area Code`, `Item Code`, `Element Code`)) %>%
  drop_na(Value) %>% 
  mutate(Prop = Value/sum(Value))
  

(bind_cols(crops = crops$Residuals, livestock = livestock$Residuals)) %>% 
  as.matrix() %>% 
  rcorr(type="spearman")
  

```


#EWS livestock
```{r}

window <- 0.5

(livestock <-
    fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
    filter(Area %in% c("Australia")) %>%
    filter(!Item %in% c("Meat, Total", "Milk,Total", "Eggs Primary", "Meat, Poultry", "Sheep and Goat Meat", "Beef and Buffalo Meat")) %>% 
    filter(!Item=="Meat, chicken") %>% 
    filter(!grepl("Milk", Item)) %>% 
    filter(grepl("Meat", Item) | grepl("Eggs", Item)) %>% 
    drop_na(Value) %>% 
    group_by(Year) %>% 
    summarise(Value= sum(Value))%>% 
    mutate(Normalized_value = resid(gam(Value~s(Year)))) %>% 
    mutate(Element="Livestock")%>% 
    mutate(Residuals = resid(gam(Value~s(Year)))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width =  round(window*length(Residuals)), 
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Mean = rollapply(data = Residuals, 
                            width = round(window*length(Residuals)), 
                            FUN = mean, 
                            align = "right", 
                            fill = NA, 
                            na.rm = T)) %>%
    mutate(CV=Variance/Mean) %>%
    mutate(AR1 = rollapply(data = Residuals, 
                           width = round(window*length(Residuals)), 
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                   width= round(window*length(Residuals)), 
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Kurtosis = rollapply(data=Residuals,
                                   width=round(window*length(Residuals)), 
                                   FUN = moments::kurtosis,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                   width=round(window*length(Residuals)), 
                                   FUN = moments::skewness,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T))
)


ggplot(livestock, 
       aes(x=Year))+
  geom_line(aes(y=Value), colour="grey1", size=1.5)+
  #geom_vline(xintercept = 2003, linetype=2)+
  scale_y_continuous(limits=c(0,4.5e+6))+
  theme_pubr()#+
  geom_line(aes(y=predict(gam(Value~s(Year)))))

unique(livestock$Item)
```

#EWS fisheries
```{r}

window <- 0.5

(fisheries <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country=="Australia") %>%
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na(Value) %>% 
    # mutate(Value = case_when(is.na(Value)~0,
    #                          TRUE ~ Value)) %>% 
    # filter(!grepl("Inland waters", Fishing_area)) %>% 
    # left_join(spp, by="Species") %>% 
    # rename(Group = ISSCAAP_Group) %>%
    # select(Year, Country, Group, Value) %>% 
    group_by(Year) %>% 
    summarise(Value=sum(Value)) %>%
    mutate(Normalized_value = (Value - mean(Value))/sd(Value)) %>% 
    mutate(Element="Fisheries") %>% 
    mutate(Residuals = resid(gam(Value~(Year)))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width = window*length(Residuals), 
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Mean = rollapply(data = Residuals, 
                            width = window*length(Residuals), 
                            FUN = mean, 
                            align = "right", 
                            fill = NA, 
                            na.rm = T)) %>%
    mutate(CV=Variance/Mean) %>%
    mutate(AR1 = rollapply(data = Residuals, 
                           width = window*length(Residuals), 
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                   width= window*length(Residuals),
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Kurtosis = rollapply(data=Residuals,
                                   width=window*length(Residuals),
                                   FUN = moments::kurtosis,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                   width=0.5*length(Residuals),
                                   FUN = moments::skewness,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T))
)



ggplot(fisheries,
       aes(x=Year)) +
  geom_line(aes(y=Value))+
  geom_line(aes(y=predict(gam(Value~s(Year)))))


unique(livestock$Item)

```




```{r}

(aquaculture <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country=="Chile") %>%
    #filter(Species =="Atlantic salmon") %>% 
    #filter(!grepl("Inland waters", Farming_area)) %>% 
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    #filter(Year >1980) %>% 
    drop_na() %>% 
    group_by(Year) %>% 
    summarise(Value=sum(Value)) %>%
    mutate(Normalized_value = (Value - mean(Value))/sd(Value)) %>% 
    mutate(Element="Aquaculture") %>% 
    mutate(Residuals = resid(loess(Normalized_value~(Year), span=.4))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width= window*length(Residuals),
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Mean = rollapply(data = Residuals, 
                            width= window*length(Residuals),
                            FUN = mean, 
                            align = "right", 
                            fill = NA, 
                            na.rm = T)) %>%
    mutate(CV=Variance/Mean) %>% 
    mutate(AR1 = rollapply(data = Residuals, 
                           width= window*length(Residuals),
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                  width= window*length(Residuals),
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
   mutate(Kurtosis = rollapply(data=Residuals,
                                   width=window*length(Residuals),
                                   FUN = moments::kurtosis,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                   width=0.5*length(Residuals),
                                   FUN = moments::skewness,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T))
)


ggplot(aquaculture, 
       aes(x=Year))+
  geom_line(aes(y=Return_rate))
  #geom_line(aes(y=predict(loess(Value~Year, span=.25))))+
  #geom_vline(xintercept = 2009, linetype=2)
  



aquaculture %>% 
  filter(Species=="Whiteleg shrimp") %>% 
  drop_na(Value) %>% 
  group_by(Species, Year) %>% 
  summarise(Value=sum(Value)) %>% 
  ggplot(aes(x=Year, y=Value, colour=Species))+geom_line()+
  ggsave("test_aqua.tiff", dpi=600, device="tiff", width=10, height=4)


unique(aquaculture$Species)

```

#Trade data
```{r}
window <- 0.5

%>% 
   mutate(Residuals = resid(loess(Value~(Year),span=0.25))) %>% 
   mutate(Variance = rollapply(data = Residuals, 
                               width =  round(window*length(Residuals)), 
                               FUN = sd, 
                               align = "right", 
                               fill = NA, 
                               na.rm = T)) %>% 
   mutate(Mean = rollapply(data = Residuals, 
                           width = round(window*length(Residuals)), 
                           FUN = mean, 
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>%
   mutate(CV=Variance/Mean) %>%
   mutate(AR1 = rollapply(data = Residuals, 
                          width = round(window*length(Residuals)), 
                          FUN = function(z,  na.rm = FALSE){
                            return(acf(z, plot=FALSE)$acf[2])
                          },  
                          align = "right", 
                          fill = NA, 
                          na.rm = T)) %>% 
   mutate(Return_rate = rollapply(data=Residuals,
                                  width= round(window*length(Residuals)), 
                                  FUN = function(z, na.rm=FALSE){
                                    ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                    return(return_rate = 1/ar1$ar[1])
                                  },
                                  align = "right", 
                                  fill = NA, 
                                  na.rm = T)) %>% 
   mutate(Kurtosis = rollapply(data=Residuals,
                               width=round(window*length(Residuals)), 
                               FUN = moments::kurtosis,
                               align = "right", 
                               fill = NA, 
                               na.rm = T)) %>% 
   mutate(Skewness = rollapply(data=Residuals,
                               width=round(window*length(Residuals)), 
                               FUN = moments::skewness,
                               align = "right", 
                               fill = NA, 
                               na.rm = T))
 
)

ggplot(food_bal, aes(x=Year))+
  geom_line(aes(y=Value))+
  geom_line(aes(y=predict(gam(Value~s(Year)))))

sort(unique(food_bal$Item))
```














unique(fisheries$Country)


ggplot(fisheries, aes(Year))+
  geom_line(aes(y=(AR1)))

crops$Variance

crops_var <- (crops$Variance[28:57]-mean(crops$Variance[28:57]))/sd(crops$Variance[28:57]) 

crops_ar <- (crops$AR1[28:57]-mean(crops$AR1[28:57]))/sd(crops$AR1[28:57]) 

crops_comp <- crops_var+crops_ar



fisheries_var <- (fisheries$Variance[34:68]-mean(fisheries$Variance[34:68]))/sd(fisheries$Variance[34:68]) 

fisheries_ar <- (fisheries$AR1[34:68]-mean(fisheries$AR1[34:68]))/sd(fisheries$AR1[34:68]) 

fisheries_comp <- fisheries_var+fisheries_ar




plot(fisheries_comp, type="l")



  geom_line(aes(y=predict(loess(Value~Year, span = 0.4))))
            
            
            
              +
  geom_line(aes(y=(AR1-mean(AR1))/sd(AR1)))
  geom_vline(xintercept = 2007)


generic_ews(fisheries$Value, winsize = 50, detrending = "loess", span = 25)

plot(fisheries$Residuals/sd(fisheries$Residuals), type = "l")


sum(fisheries$Residuals/sd(fisheries$Residuals))

sum(fisheries$Residuals)

ggplot(fisheries %>% filter(Species=="Australian spiny lobster"), aes(Year, Value, colour=Species))+
  geom_line() +
  theme_pubr()+
  theme(legend.position = "bottom") +
  ggsave("test.tiff", dpi=600, device = "tiff", width=10, height = 15)




fisheries %>% filter(Year %in% c(2000,2001,2002)) %>% arrange(-Year, -Value)

```









(livestock <-
  fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
  filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
  filter(Area ==  "World") %>% 
  na.omit() %>% 
  group_by(Year) %>% 
  summarise(Value= sum(Value))%>% 
  mutate(Normalized_value = gam.func(Value, Year)) %>% 
  mutate(Element="Livestock")

)





(fisheries <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    mutate(Value = case_when(is.na(Value)~0,
                             TRUE ~ Value)) %>% 
    filter(!grepl("Inland waters", Fishing_area)) %>% 
    left_join(spp, by="Species") %>% 
    rename(Group = ISSCAAP_Group) %>%
    select(Year, Country, Group, Value) %>% 
    group_by(Country, Year) %>% 
    summarise(Value=sum(Value)) %>% 
    ungroup() %>% 
    group_by(Country) %>% 
    nest() %>% 
    mutate(Normalized_value = purrr::map(data, ~(gam.simple(.$Value, .$Year)))) %>% 
    unnest() %>% 
    mutate(Element = "Fisheries")
)

# drop_na() %>% 
#     group_by(Year) %>% 
#     summarise(Value = sum(Value)) %>% 
#     mutate(Normalized_value = gam.func(Value, Year)) %>% 
#     mutate(Element="Fisheries") %>% 
    




(aquaculture <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(!grepl("Inland waters", Farming_area)) %>% 
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na() %>% 
    group_by(Year) %>% 
    summarise(Value = sum(Value)) %>% 
    mutate(Normalized_value = gam.func(Value, Year)) %>% 
    mutate(Element="Aquaculture")
)



crops_cols <- brewer.pal(4, "Blues")
crops_cols <- colorRampPalette(crops_cols)(50)

 #"Wheat","Soybeans", "Potatoes",

ggplot(data=fisheries %>% 
         filter(Country=="Indonesia"), 
       aes(x=Year, y=Normalized_value))+
  geom_bar(stat ="identity")+
  theme_pubr()+
  scale_fill_manual(values=(crops_cols)) 
  





crops %>% 
  rename(Crops = Normalized_value) %>% 
  left_join(livestock, by="Year") %>% 
  rename(Livestock = Normalized_value) %>%
  mutate(Crops2 = lag(Crops,1)) %>% 
  drop_na() %>% 
  # select(Year, Crops, Livestock) %>% 
  # left_join(fisheries, by="Year") %>% 
  #rename(Fisheries = Normalized_value) %>% 
  # select(Year, Crops, Livestock, Fisheries) %>% 
  #left_join(aquaculture, by="Year") %>% 
  #rename(Aquaculture = Normalized_value) %>% 
  select(Crops2, Livestock) %>% 
  as.matrix() %>% 
  rcorr(type="pearson")






```




#Diversity vs. stability playing around

#screen data for quality (length and estimated proportion)
```{r}

#Livestock flags
#"F" - FAO estimate
#"" - Official data
#"Im" - FAO data based on imputation methods
#"Fc" - Calculated data 
#"*"  - Unofficial figure
#"A" - aggregate - may include official, semi-official or estimated or calculated
#"M" - data not available


#filter which countries have long time series (i.e not russia or belarus etc)

(complete_livestock_TS <-
   fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
   filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
   filter(!Area %in% c("Africa" , "Americas", "Asia", "Australia and New Zealand", "Caribbean" ,"Central America", "Central Asia" , "China","Eastern Africa", "Eastern Asia" , "Eastern Europe","Europe","European Union", "Land Locked Developing Countries", "Least Developed Countries" , "Low Income Food Deficit Countries", "Melanesia", "Micronesia", "Middle Africa", "Net Food Importing Developing Countries", "Northern Africa", "Northern America", "Northern Europe", "Oceania", "Small Island Developing States", "South-Eastern Asia", "South America", "Southern Africa" , "Southern Asia", "Southern Europe", "Western Africa","Western Asia","Western Europe", "World" )) %>% 
   na.omit() %>% 
   group_by(Area, Year) %>% 
   summarise(Value= sum(Value)) %>% 
   ungroup() %>% 
   group_by(Area) %>% 
   summarise(TS_length = length(Value)) %>% 
   filter(TS_length >40)
        
)

#OMIT countries where more than 20% of data (average per item/species) is estimated

(data_quality_livestock <-
    fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
    filter(Area %in% complete_livestock_TS$Area) %>% 
    arrange(Area) %>%
    filter(Year>1979) %>% 
    group_by(Area, Item) %>% 
    summarise(Prop_estimate = 1-(length(Flag[Flag %in% c("","Im", "Fc", "*", "A")])/length(Flag))) %>% 
    ungroup() %>% 
    group_by(Area) %>% 
    summarise(Mean_estimate = mean(Prop_estimate)) %>%
    filter(!(Mean_estimate>0.2 & !Area %in% c("China, mainland", "Bangladesh")))
)

(livestock_countries_include <- data_quality_livestock$Area[data_quality_livestock$Area!="Polynesia"])


#Fisheries data


#Flags
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information


#filter which countries have long time series (i.e not russia or belarus etc)
(complete_fish_ts <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>%
    mutate(Estimated = case_when(grepl(" F", Value)~ "Yes",
                                 TRUE ~ "No")) %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na() %>%
    group_by(Country, Year) %>% 
    summarise(Value = sum(Value)) %>% 
    ungroup() %>% 
    group_by(Country) %>%
    summarise(Ts_length = length(Value)) %>%
    filter(Ts_length>60)
)


#OMIT countries where more than 20% of data (average per item/species) is estimated
(data_quality_fish <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight" & Country %in% complete_fish_ts$Country) %>%
    mutate(Estimated = case_when(grepl(" F", Value)~ "Yes",
                                 TRUE ~ "No")) %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na() %>% 
    filter(Year>1979) %>% 
    group_by(Country, Species) %>% 
    summarise(Prop_estimate = length(Estimated[Estimated=="Yes"])/length(Estimated)) %>% 
    ungroup() %>% 
    group_by(Country) %>% 
    summarise(Mean_estimated = mean(Prop_estimate)) %>% 
    filter(!(Mean_estimated>0.2 & Country!="India"))
)


fisheries_countries_include <- data_quality_fish$Country






#Aquaculture data




#filter which countries have long time series (i.e not russia or belarus etc)
(complete_ts_aqua <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>%
    mutate(Estimated = case_when(grepl(" F", Value)~ "Yes",
                                 TRUE ~ "No")) %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na() %>% 
    group_by(Country, Year) %>% 
    summarise(Value = sum(Value)) %>% 
    ungroup() %>% 
    group_by(Country) %>%
    summarise(Ts_length = length(Value)) %>% 
    filter(Ts_length >40)
)

#OMIT countries where more than 20% of data (average per item/species) is estimated
(data_quality_aqua <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight" & Country %in% complete_ts_aqua$Country) %>%
    mutate(Estimated = case_when(grepl(" F", Value)~ "Yes",
                                 TRUE ~ "No")) %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>%
    filter(Year>1979) %>%
    drop_na() %>% 
    group_by(Country, Species) %>% 
    summarise(Prop_estimate = length(Estimated[Estimated=="Yes"])/length(Estimated)) %>% 
    ungroup() %>% 
    group_by(Country) %>% 
    summarise(Mean_estimated = mean(Prop_estimate)) %>% 
    filter(!(Mean_estimated>0.2 & !Country %in% c("China", "India")))
    
)


(aquaculture_countries__include <- data_quality_aqua$Country)
```

#tidy and merge production data for livestock, fisheries and aquaculture

```{r}


#Aquaculture 

#species

spp <- fread("all_spp.csv", header=TRUE) %>% 
  rename(Species = Name_en)



(aqua_prod <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    filter(Country %in% aquaculture_countries__include) %>% 
    mutate(Species = case_when(grepl("\\[|\\]", Species) ~ gsub("\\[|\\]","", Species),
                               TRUE ~ Species)) %>% 
    na.omit() %>% 
    left_join(spp, by="Species") %>% 
    arrange(Country) %>% 
    select(Country, Species, Environment, Year, Value, Scientific_Name1, Major_Group) %>% 
    mutate(Scientific_Name1 = case_when(Species == "Hairy marron crayfish"~ "Cherax tenuimanus",
                                        is.na(Major_Group) ~ Species,
                                        TRUE~Scientific_Name1)) %>% 
    rename(Group = Major_Group) %>% 
    left_join(spp, by="Scientific_Name1") %>%
    mutate(Group = case_when(is.na(Group)~ Major_Group,
                             TRUE ~ Group)) %>% 
    select(Country, Species.x, Environment, Year, Value, Scientific_Name1, Group) %>% 
    filter(!Group %in% c("PLANTAE AQUATICAE")) %>% 
    filter(Year>1979) %>% 
    mutate(Edible_Value = case_when(Group == "PISCES" ~Value/1.15, #from Tacon and Metian 2013
                             Group == "MOLLUSCA" ~ Value/6,
                             Group =="CRUSTACEA" ~ Value /2.8,
                             TRUE ~ Value)) %>% 
    mutate(iso_code = countrycode(Country, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    rename(Item_species = Species.x) %>% 
    select(Country, iso_code, Item_species, Year, Value, Edible_Value)
)




#FISHERIES 

(fisheries_prod <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>%
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>%
    filter(Country %in% fisheries_countries_include) %>% 
    mutate(Species = case_when(grepl("\\[|\\]", Species) ~ gsub("\\[|\\]","", Species),
                               TRUE ~ Species)) %>% 
    drop_na() %>%
    left_join(spp, by="Species") %>% 
    arrange(Country) %>% 
    select(Country, Species, Fishing_area, Year, Value, Scientific_Name1, Major_Group) %>% 
    mutate(Scientific_Name1 = case_when(Species == "Diamondback terrapin"~ "Malaclemys terrapin",
                                        is.na(Major_Group) ~ Species,
                                        TRUE~Scientific_Name1)) %>% 
    rename(Group = Major_Group) %>% 
    left_join(spp, by="Scientific_Name1") %>%
    mutate(Group = case_when(is.na(Group) ~ Major_Group,
                             
                             TRUE ~ Group)) %>% 
    select(Country, Species.x, Fishing_area, Year, Value, Scientific_Name1, Group) %>% 
    mutate(Group = case_when(is.na(Group)~"CRUSTACEA",
                             TRUE ~ Group)) %>% 
    filter(!Group %in% c("PLANTAE AQUATICAE")) %>% 
    filter(Year>1979) %>% 
    mutate(Edible_Value = case_when(Group == "PISCES" ~Value/1.15, #from Tacon and Metian 2013
                             Group == "MOLLUSCA" ~ Value/6,
                             Group =="CRUSTACEA" ~ Value /2.8,
                             TRUE ~ Value)) %>% 
    mutate(iso_code = countrycode(Country, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    drop_na() %>% 
    rename(Item_species = Species.x) %>% 
    select(Country, iso_code, Item_species, Year, Value, Edible_Value) %>% 
    filter(iso_code %in% aqua_prod$iso_code)
  
)





#LIVESTOCK


omit_items <- c("Eggs Primary","Beef and Buffalo Meat","Meat, Poultry", "Beeswax", "Sheep and Goat Meat")

(livestock_prod <-
    fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Unit=="tonnes" &
             Element=="Production" &
             !Item %in% omit_items &
             !(grepl("indigenous", Item)|grepl("Total", Item)|grepl("Hides", Item)|grepl("Skins", Item)|grepl("Wool", Item)|grepl("Hair", Item))) %>%
    filter(Area %in% livestock_countries_include) %>% 
    mutate(iso_code = countrycode(Area, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    mutate(iso_code = case_when(Area=="Eswatini" ~ "SWZ",
                                TRUE ~ iso_code)) %>% 
    rename(Country=Area,
           Item_species = Item) %>% 
    select(Country, iso_code, Item_species, Year, Value) %>% 
    mutate(Edible_Value = case_when(Item_species=="Snails, not sea"~ Value/6,
                                    TRUE ~ Value)) %>% 
    filter(Year>1979)%>% 
    filter(iso_code %in% aqua_prod$iso_code)
)  

unique(aqua_prod$iso_code) %in% unique(livestock_prod$iso_code)   
unique(fisheries_prod$Country)
unique(livestock_prod$Country)




#readjust aquaculture and fisheries nations included to account for the lowest number of nations (livestock)

aqua_prod_adj <- 
  aqua_prod %>% 
  filter(iso_code %in% livestock_prod$iso_code)

fisheries_prod_adj <- 
  fisheries_prod %>%
  filter(iso_code %in% livestock_prod$iso_code)


animal_wo_aqua <- 
  bind_rows(livestock_prod, fisheries_prod_adj)

animal_with_aqua <- 
  bind_rows(livestock_prod, fisheries_prod_adj, aqua_prod_adj) %>% 
  arrange(iso_code)

total_seafood <- 
  bind_rows(fisheries_prod_adj, aqua_prod_adj)


```

#Diversity and stability calculations variance for whole period 1980-2017 
```{r}

#Divide the biomass of item_species x in your data by the total biomass of all item_species. ...
#Multiply the fraction by its natural log (P1 * ln P1)
#Repeat this for all of the different species that you have. ...
#Sum all the - (Pi * ln Pi) products to get the value of H.



#ALL ANIMAL PRODUCTION


#Animal production Without aquaculture

(country_tots <- 
   animal_wo_aqua %>% 
   na.omit() %>% 
   group_by(iso_code) %>% 
   summarise(Country_total=sum(Edible_Value))
 
)

(national_div_no_aqua <- 
    animal_wo_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(national_var_no_aqua <- 
    animal_wo_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~(((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total))))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(no_aqua_div_var <- 
  national_div_no_aqua %>% 
  left_join(national_var_no_aqua, by="iso_code")
)

model_no_aqua <- (glm(Variance~H, data=no_aqua_div_var, family = "quasibinomial"))
summary(model_no_aqua)

fits <- predict(model_no_aqua, type = "response", se.fit = TRUE)$fit
neg_error <- fits - 1.96 *predict(model_no_aqua, type = "response", se.fit = TRUE)$se.fit
pos_error <- fits + 1.96 *predict(model_no_aqua, type = "response", se.fit = TRUE)$se.fit




no_aqua_plot <- 
  ggplot(data = no_aqua_div_var, aes(x=H))+
  geom_ribbon(aes(ymin=neg_error, ymax=pos_error), alpha=0.3, fill="dodgerblue")+
  geom_line(aes(y=fits))+
  geom_point(aes(y=Stability),colour="dodgerblue", size=.75)+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.3))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Without aquaculture")










#Animal production with aquaculture



(national_div_with_aqua <- 
    animal_with_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(national_var_with_aqua <- 
    animal_with_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~(((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total))))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Stability= sd(Prop_change))
)


(aqua_div_var <- 
  national_div_with_aqua %>% 
  left_join(national_var_with_aqua, by="iso_code")
)

model_aqua <- (glm(Variance~H, data=aqua_div_var, family = "quasibinomial"))
summary(model_aqua)

fits2 <- predict(model_aqua, type = "response", se.fit = TRUE)$fit
neg_error2 <- fits - 1.96 *predict(model_aqua, type = "response", se.fit = TRUE)$se.fit
pos_error2 <- fits + 1.96 *predict(model_aqua, type = "response", se.fit = TRUE)$se.fit



aqua_plot <- 
  ggplot(data = aqua_div_var, aes(x=H))+
  geom_ribbon(aes(ymin=neg_error2, ymax=pos_error2), alpha=0.3, fill="blue")+
  geom_line(aes(y=fits2))+
  geom_point(aes(y=Variance),colour="blue", size=.75)+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.3))+
  theme_pubr() +
  theme(text=element_text(size=7),
        axis.title.y = element_blank())+
  labs(x="Shannon-Weiner Index (H)", title = "With aquaculture")

ggarrange(no_aqua_plot, aqua_plot, nrow = 1, ncol=2, align="hv", labels = c("A", "B"), font.label = list(size=7))+
  ggsave("Supplementary Figure X.tiff", dpi=600, device="tiff", width=12, height=5, units = "cm")+
  ggsave("Supplementary Figure X.pdf", dpi=600, device="pdf", width=12, height=5, units = "cm")





(both <- bind_rows(
  no_aqua_div_var %>% 
    mutate(Element="Without aquaculture"),
  
  aqua_div_var %>% 
    mutate(Element="With aquaculture"))
)


both_plot <- 
  ggplot(data = both, aes(x=H, fill=Element))+
  geom_ribbon(aes(ymin=neg_error, ymax=pos_error), alpha=0.3, fill="blue")+
  geom_line(aes(y=fits))+
  geom_ribbon(aes(ymin=neg_error, ymax=pos_error), alpha=0.3, fill="blue")+
  geom_line(aes(y=fits2))+
  geom_point(aes(y=Variance),colour="blue", size=.75)+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.3))+
  theme_pubr() +
  theme(text=element_text(size=7),
        axis.title.y = element_blank())+
  labs(x="Shannon-Weiner Index (H)")


```

#Livestock production and aquaculture
```{r}

(livestock_tots <- 
    livestock_prod %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(livestock_div_no_aqua <- 
    livestock_prod %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(livestock_var_no_aqua <- 
    livestock_prod %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(livestock_div_var <- 
  livestock_div_no_aqua %>% 
  left_join(livestock_var_no_aqua, by="iso_code")
)

model_livestock <- (glm(Variance~H, data=livestock_div_var %>% filter(iso_code!="FRO"), family = "quasibinomial"))
summary(model_livestock)


livestock_only_plot <- 
  ggplot(data = livestock_div_var %>% filter(iso_code!="FRO"), aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_livestock, type="response")))+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.4))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Livestock - no aquaculture")




(livestock_aqua <- 
  bind_rows(livestock_prod, aqua_prod_adj) %>% 
    arrange(Country))


(livestock_aqua_tots <- 
    livestock_aqua %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(livestock_div_with_aqua <- 
    livestock_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(livestock_var_with_aqua <- 
    livestock_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(livestock_aqua_div_var <- 
  livestock_div_with_aqua %>% 
  left_join(livestock_var_with_aqua, by="iso_code")
)

model_livestock_aqua <- (glm(Variance~H, data=livestock_aqua_div_var %>% filter(iso_code!="FRO"), family = "quasibinomial"))
summary(model_livestock_aqua)
influence.measures(model_livestock_aqua)


livestock_aqua_plot <- 
  ggplot(data = livestock_aqua_div_var %>% filter(iso_code!="FRO"), aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_livestock_aqua, type="response")))+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.4))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Livestock with aquaculture")



ggarrange(livestock_only_plot, livestock_aqua_plot, nrow = 1, ncol=2, align="hv", labels = c("A", "B"), font.label = list(size=7))+
  ggsave("Supplementary Figure X2.tiff", dpi=600, device="tiff", width=12, height=5, units = "cm")+
  ggsave("Supplementary Figure X2.pdf", dpi=600, device="pdf", width=12, height=5, units = "cm")



#Fisheries and aquaculture



(fisheries_tots <- 
    fisheries_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(fisheries_div_no_aqua <- 
    fisheries_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(fisheries_var_no_aqua <- 
    fisheries_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(fisheries_div_var <- 
  fisheries_div_no_aqua %>% 
  left_join(fisheries_var_no_aqua, by="iso_code")
)

model_fisheries <- (glm(Variance~H, data=fisheries_div_var, family = "quasibinomial"))
summary(model_fisheries)


fisheries_only_plot <- 
  ggplot(data = fisheries_div_var, aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_fisheries, type="response")))+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.4))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Fisheries - no aquaculture")




(fisheries_aqua <- 
  bind_rows(fisheries_prod_adj, aqua_prod_adj) %>% 
    arrange(Country))


(fisheries_aqua_tots <- 
    fisheries_aqua %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(fisheries_div_with_aqua <- 
    fisheries_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(fisheries_var_with_aqua <- 
    fisheries_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(fisheries_aqua_div_var <- 
  fisheries_div_with_aqua %>% 
  left_join(fisheries_var_with_aqua, by="iso_code")
)

model_fisheries_aqua <- (glm(Variance~H, data=fisheries_aqua_div_var, family = "quasibinomial"))
summary(model_fisheries_aqua)



fisheries_aqua_plot <- 
  ggplot(data = fisheries_aqua_div_var, aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_fisheries_aqua, type="response", se.fit=TRUE)))+
  scale_x_continuous(limits=c(0,4))+
  scale_y_continuous(limits = c(0,0.7))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Fisheries with aquaculture")



ggarrange(fisheries_only_plot, fisheries_aqua_plot, nrow = 1, ncol=2, align="hv", labels = c("A", "B"), font.label = list(size=7))+
  ggsave("Supplementary Figure X3.tiff", dpi=600, device="tiff", width=12, height=5, units = "cm")+
  ggsave("Supplementary Figure X3.pdf", dpi=600, device="pdf", width=12, height=5, units = "cm")



#Aquaculture only
(aqua_tots <- 
    aqua_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(aqua_div <- 
    aqua_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(aqua_var <- 
    aqua_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(aqua_div_var <- 
  aqua_div_no_aqua %>% 
  left_join(aqua_var_no_aqua, by="iso_code")
)

model_aqua <- (glm(Variance~H, data=aqua_div_var, family = "quasibinomial"))
summary(model_aqua)

hist(aqua_div_var$Variance)


aqua_only_plot <- 
  ggplot(data = aqua_div_var, aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_aqua, type="response")))+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.4))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Aquaculture only")


















```


#Change in country level variance with diversity for whole period 1980-2017
```{r}
(country_tots <- 
   animal_wo_aqua %>% 
   na.omit() %>% 
   group_by(iso_code) %>% 
   summarise(Country_total=sum(Edible_Value))
 
)

(national_div_no_aqua <- 
    animal_wo_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H_wo_aqua=sum(Pxln_P))
)


(national_var_no_aqua <- 
    animal_wo_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~(((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total))))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance_wo_aqua= sd(Prop_change))
)



(no_aqua_div_var <- 
  national_div_no_aqua %>% 
  left_join(national_var_no_aqua, by="iso_code")
)

##with aqua
(national_div_with_aqua <- 
    animal_with_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(national_var_with_aqua <- 
    animal_with_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~(((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total))))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)


(aqua_div_var <- 
  national_div_with_aqua %>% 
  left_join(national_var_with_aqua, by="iso_code")
)

(aqua_no_aqua <- 
  left_join(no_aqua_div_var, aqua_div_var, by="iso_code") %>% 
    mutate(H_change = (H-H_wo_aqua)/H_wo_aqua, Variance_change = (Variance-Variance_wo_aqua)/Variance_wo_aqua)) 



ggplot(aqua_no_aqua, aes(x=H_change, y=Variance_change))+
  geom_point()


# model_aqua_change <- gam(Stability_change~s(H_change), data=aqua_no_aqua)
# 
# 
# ggplot(data=aqua_no_aqua , 
#        aes(x=reorder(iso_code, Stability_change), y=Stability_change))+
#   geom_bar(stat="identity")+
#   coord_flip()+
#   theme_pubr()
#   

(var_div_change <- 
    bind_rows(
      
      aqua_no_aqua %>% 
        select(iso_code, H_change) %>% 
        rename(Value=H_change) %>% 
        mutate(Element="Diversity"),
      
      aqua_no_aqua %>% 
        select(iso_code, Variance_change) %>% 
        rename(Value=Variance_change) %>%
        mutate(Element="Variance")
      
    )
)



ggplot(data = var_div_change, aes(x=reorder(iso_code, Value), y=Value, fill=Element))+
  geom_bar(stat="identity", position = "dodge")+
  coord_flip()+
  theme_pubr()



```
