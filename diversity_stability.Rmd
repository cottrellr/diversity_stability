---
title: "Aquaculture and stability"
author: "Richard Cottrell"
date: "24 June 2019"
output: html_document
---

```{r}
library(zoo)
library(Hmisc)
library(mgcv)
library(data.table)
library(tidyverse)
library(ggpubr)
library(ggsci)
library(countrycode)
library(RColorBrewer)
library(rvest)
library(stringr)
library(magrittr)

```




#Sentiment analysis - aquaculture
```{r}
#LATEST SEARCH ACROSS ALL SECTORS 21/07/19


#search terms "(aquaculture OR fish farm) <STATE> Australia"


#tasmania
tasmania <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20tasmania%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  tasmania %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")

lapply(headlines, function{x}
       
)




tas_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Tasmania")


#quuensland

queensland <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20queensland%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  queensland %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

qld_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Queensland")



#south australia

SA <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20south%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  SA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

SA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "South Australia")



#Western australia

WA <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20western%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  WA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

WA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Western Australia")


#NSW


NSW <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20new%20south%20wales%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NSW_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "New South Wales")



VIC <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20victoria%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

VIC_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Victoria")




NT <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20northern%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Northern Territory")


ACT <- read_html("https://news.google.com/search?q=(aquaculture%20OR%20fish%20farm)%20australian%20capital%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  ACT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

ACT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Australian Capital Territory")



aquaculture_headlines <- 
  bind_rows(tas_headlines, qld_headlines, SA_headlines, VIC_headlines, NSW_headlines, NT_headlines, WA_headlines, ACT_headlines) %>% 
  mutate(System = "Aquaculture") %>% 
  select(System, State, Headline) %>% 
  write_csv("Aquaculture headlines.csv")





```


#sentiment analysis - fisheries

```{r}

#search terms "(fisheries OR fishing) <STATE> Australia"



#tasmania
tasmania <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20tasmania%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  tasmania %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

tas_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Tasmania")


#quuensland

queensland <- read_html("https://news.google.com/search?q=(agriculture)%20queensland%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  queensland %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

qld_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Queensland")



#south australia

SA <- read_html("https://news.google.com/search?q=(agriculture)%20south%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  SA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

SA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "South Australia")



#Western australia

WA <- read_html("https://news.google.com/search?q=(agriculture)%20western%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  WA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

WA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Western Australia")


#NSW


NSW <- read_html("https://news.google.com/search?q=(agriculture)%20new%20south%20wales%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NSW_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "New South Wales")



VIC <- read_html("https://news.google.com/search?q=(agriculture)%20victoria%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

VIC_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Victoria")




NT <- read_html("https://news.google.com/search?q=(agriculture)%20northern%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Northern Territory")


ACT <- read_html("https://news.google.com/search?q=(agriculture)%20australian%20capital%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  ACT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

ACT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Australian Capital Territory")



agriculture_headlines <- 
  bind_rows(tas_headlines, qld_headlines, SA_headlines, VIC_headlines, NSW_headlines, NT_headlines, WA_headlines, ACT_headlines) %>% 
  mutate(System = "Agriculture") %>% 
  select(System, State, Headline) %>% 
  write_csv("Agriculture headlines.csv")



```


#sentiment analysis - agriculture
```{r}
#search terms "(agriculture) <STATE> Australia"



#tasmania
tasmania <- read_html("https://news.google.com/search?q=(agriculture)%20tasmania%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  tasmania %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

tas_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Tasmania")


#quuensland

queensland <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20queensland%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  queensland %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

qld_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Queensland")



#south australia

SA <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20south%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  SA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

SA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "South Australia")



#Western australia

WA <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20western%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  WA %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

WA_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Western Australia")


#NSW


NSW <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20new%20south%20wales%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NSW_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "New South Wales")



VIC <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20victoria%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NSW %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

VIC_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Victoria")




NT <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20northern%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  NT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

NT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Northern Territory")


ACT <- read_html("https://news.google.com/search?q=(fishing%20or%20fisheries)%20australian%20capital%20territory%20australia&hl=en-AU&gl=AU&ceid=AU%3Aen") 

headlines <- 
  ACT %>% 
  html_nodes("article") %>%
  html_text("span") %>%
  str_split("(?<=[a-z0-9!?\\.])(?=[A-Z])")
  

ACT_headlines <- data_frame(Headline = unlist(lapply(headlines, '[[', 1)), State = "Australian Capital Territory")



fisheries_headlines <- 
  bind_rows(tas_headlines, qld_headlines, SA_headlines, VIC_headlines, NSW_headlines, NT_headlines, WA_headlines, ACT_headlines) %>% 
  mutate(System = "Agriculture") %>% 
  select(System, State, Headline) %>% 
  write_csv("Agriculture headlines.csv")


```

#food production data

#CROPS
```{r}

### CROPS

Cereals <- c("Barley", "Maize", "Maize, green", "Oats", "Rice, paddy", "Wheat", "Sorghum", "Rye", "Millet", "Grain, mixed", "Cereals, nes")

Vegetables <- c("Artichokes", "Asparagus", "Cabbages and other brassicas", "Lettuce and chicory", "Spinach", "Cucumbers and gherkins", "Eggplants (aubergines)", "Tomatoes",  "Watermelons", "Melons, other (inc.cantaloupes)", "Pumpkins, squash and gourds", "Carrots and turnips", "Garlic", "Onions, shallots, green", "Leeks, other alliaceous vegetables", "Mushrooms and truffles", "Okra", "Vegetables, leguminous nes", "Vegetables, fresh nes", "String beans")


Fruits.Nuts<-c("Avocados", "Bananas", "Cranberries", "Plantains", "Dates", "Figs", "Mangoes, mangosteens, guavas", "Papayas", "Pineapples", "Grapefruit (inc. pomelos)",  "Lemons and limes", "Oranges", "Tangerines, mandarins, clementines, satsumas", "Grapes", "Berries nes", "Blueberries", "Gooseberries", "Kiwi fruit","Raspberries","Strawberries", "Apples","Apricots", "Cherries","Cherries, sour", "Peaches and nectarines", "Pears", "Quinces", "Plums and sloes", "Almonds, with shell", "Cashew nuts, with shell","Chestnut", "Hazelnuts, with shell", "Pistachios", "Walnuts, with shell", "Cashewapple", "Areca nuts", "Currants", "Nuts, nes", "Kola nuts", "Fruit, citrus nes", "Fruit, fresh nes",	"Fruit, pome nes"	,	"Fruit, stone nes", "Fruit, tropical fresh nes", "Brazil nuts, with shell", "Bambara beans" , "Karite nuts (sheanuts)")

Oil.crops <- c("Soybeans", "Groundnuts, with shell", "Castor oil seed", "Linseed", "Mustard seed", "Rapeseed" , "Safflower seed","Sesame seed", "Sunflower seed", "Oilseeds nes", "Coconuts" , "Olives", "Oil, palm fruit", "Oil, palm", "Palm kernels")


Roots.Tubers <- c("Potatoes", "Sweet potatoes" , "Cassava", "Cassava leaves" , "Yams", "Yautia (cocoyam)", "Taro (cocoyam)", "Tung nuts", "Roots and tubers, nes")

Beverage.Spices <- c("Coffee, green", "Tea", "Mat\xe9", "Cocoa, beans", "Anise, badian, fennel, coriander", "Chillies and peppers, dry", "Chillies and peppers, green", "Pepper (piper spp.)", "Nutmeg, mace and cardamoms" , "Cinnamon (canella)","Cloves" , "Ginger", "Vanilla" , "Spices, nes")

Pulses <- c("Beans, dry", "Beans, green", "Broad beans, horse beans, dry", "Chick peas", "Lentils", "Lupins", "Peas, dry" , "Peas, green", "Pigeon peas", "Pulses, nes", "Cow peas, dry")

Sugar.crops <- c("Sugar beet", "Sugar cane", "Sugar crops, nes")

Fibres <- c("Agave fibres nes", "Bastfibres, other",  "Flax fibre and tow"  , "Kapok fibre", "Manila fibre (abaca)",  "Fibre crops nes",   "Jute & Jute-like Fibres", "Cotton lint" ,"Cottonseed", "Seed cotton", "Gums, natural", "Jute")






prod <- crops$Value[crops$Item=="Maize"]
Year <- crops$Year[crops$Item=="Maize"]

model <- gam(prod~s(Year))
model$residuals/sd(model$residuals)



#Sugar cane, Wheat Barley, Seed Cotton, Sorghum, Seed Cotton



window <- 0.36

(crops <- 
    fread("Production_Crops_E_All_Data_(Normalized).csv", header=TRUE) %>% 
    filter(Element=="Production") %>%
    filter(Area %in% c("World")) %>% 
    #filter(Year >1979) %>% 
    #filter(Item %in% c("Rice, paddy")) %>% 
    # mutate(Decade = case_when(Year %in% c(1960:1969)~"1960s",
    #                           Year %in% c(1970:1979)~"1970s",
    #                           Year %in% c(1980:1989)~"1980s",
    #                           Year %in% c(1990:1999)~"1990s",
    #                           Year %in% c(2000:2009)~"2000s",
    #                           Year %in% c(2010:2019)~"2010s")) %>% 
    # mutate(Group = case_when(Item %in% Cereals ~ "Cereals",
    #                          Item %in% Vegetables~"Vegetables",
    #                          Item %in% Fruits.Nuts~"Fruits & Nuts",
    #                          Item %in% Oil.crops~"Oil crops",
    #                          Item %in% Roots.Tubers~"Roots & tubers",
  #                          Item %in% Beverage.Spices~"Bevs. & spices",
  #                          Item %in% Pulses~"Pulses",
  #                          Item %in% Sugar.crops~"Sugar crops",
  #                          Item %in% Fibres~"Fibres",
  #                          TRUE ~"Other crops")) %>% 
  drop_na(Value) %>% 
    group_by(Year) %>% 
    summarise(Value=sum(Value)) %>% 
    mutate(Normalized_value = (Value -mean(Value))/sd(Value)) %>% 
    mutate(Element="Crops") %>% 
    mutate(Residuals = resid(gam(Value~s(Year)))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width = round(window*length(Residuals)), 
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Mean = rollapply(data = Residuals, 
                            width = round(window*length(Residuals)), 
                            FUN = mean, 
                            align = "right", 
                            fill = NA, 
                            na.rm = T)) %>%
    mutate(CV=Variance/Mean) %>%
    mutate(AR1 = rollapply(data = Residuals, 
                           width = round(window*length(Residuals)), 
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                   width= round(window*length(Residuals)), 
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Kurtosis = rollapply(data=Residuals,
                                width= round(window*length(Residuals)), 
                                FUN = moments::kurtosis,
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                width= round(window*length(Residuals)), 
                                FUN = moments::skewness,
                                align = "right", 
                                fill = NA, 
                                na.rm = T))
)




ggplot(crops, 
       aes(x=Year))+
  geom_line(aes(y=AR1))+
    #annotate("segment", ymin=-Inf, ymax = Inf, xmin = 2002, xmax = 2003, alpha=0.5)
  geom_vline(xintercept = 2003, linetype=2)+theme_pubr()


  cor(x=crops$Year[28:57], y=crops$Return_rate[28:57], method = "kendall")

unique(crops$Item)

crops %>% 
  filter(Year==2000) %>% 
  arrange(-Value) %>% 
  filter(!(Item %in% c("Cereals (Rice Milled Eqv)"))) %>% 
  filter(!grepl("Total", Item)) %>% 
  select(-c(`Area Code`, `Item Code`, `Element Code`)) %>%
  drop_na(Value) %>% 
  mutate(Prop = Value/sum(Value))
  

(bind_cols(crops = crops$Residuals, livestock = livestock$Residuals)) %>% 
  as.matrix() %>% 
  rcorr(type="spearman")
  

```



```{r}

window <- 0.5

(livestock <-
    fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
    filter(Area %in% c("Australia")) %>%
    filter(!Item %in% c("Meat, Total", "Milk,Total", "Eggs Primary", "Meat, Poultry", "Sheep and Goat Meat", "Beef and Buffalo Meat")) %>% 
    filter(!Item=="Meat, chicken") %>% 
    filter(!grepl("Milk", Item)) %>% 
    filter(grepl("Meat", Item) | grepl("Eggs", Item)) %>% 
    drop_na(Value) %>% 
    group_by(Year) %>% 
    summarise(Value= sum(Value))%>% 
    mutate(Normalized_value = resid(gam(Value~s(Year)))) %>% 
    mutate(Element="Livestock")%>% 
    mutate(Residuals = resid(gam(Value~s(Year)))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width =  round(window*length(Residuals)), 
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Mean = rollapply(data = Residuals, 
                            width = round(window*length(Residuals)), 
                            FUN = mean, 
                            align = "right", 
                            fill = NA, 
                            na.rm = T)) %>%
    mutate(CV=Variance/Mean) %>%
    mutate(AR1 = rollapply(data = Residuals, 
                           width = round(window*length(Residuals)), 
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                   width= round(window*length(Residuals)), 
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Kurtosis = rollapply(data=Residuals,
                                   width=round(window*length(Residuals)), 
                                   FUN = moments::kurtosis,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                   width=round(window*length(Residuals)), 
                                   FUN = moments::skewness,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T))
)


ggplot(livestock, 
       aes(x=Year))+
  geom_line(aes(y=Value), colour="grey1", size=1.5)+
  #geom_vline(xintercept = 2003, linetype=2)+
  scale_y_continuous(limits=c(0,4.5e+6))+
  theme_pubr()#+
  geom_line(aes(y=predict(gam(Value~s(Year)))))

unique(livestock$Item)
```

```{r}

window <- 0.5

(fisheries <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country=="Australia") %>%
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na(Value) %>% 
    # mutate(Value = case_when(is.na(Value)~0,
    #                          TRUE ~ Value)) %>% 
    # filter(!grepl("Inland waters", Fishing_area)) %>% 
    # left_join(spp, by="Species") %>% 
    # rename(Group = ISSCAAP_Group) %>%
    # select(Year, Country, Group, Value) %>% 
    group_by(Year) %>% 
    summarise(Value=sum(Value)) %>%
    mutate(Normalized_value = (Value - mean(Value))/sd(Value)) %>% 
    mutate(Element="Fisheries") %>% 
    mutate(Residuals = resid(gam(Value~(Year)))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width = window*length(Residuals), 
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Mean = rollapply(data = Residuals, 
                            width = window*length(Residuals), 
                            FUN = mean, 
                            align = "right", 
                            fill = NA, 
                            na.rm = T)) %>%
    mutate(CV=Variance/Mean) %>%
    mutate(AR1 = rollapply(data = Residuals, 
                           width = window*length(Residuals), 
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                   width= window*length(Residuals),
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Kurtosis = rollapply(data=Residuals,
                                   width=window*length(Residuals),
                                   FUN = moments::kurtosis,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                   width=0.5*length(Residuals),
                                   FUN = moments::skewness,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T))
)



ggplot(fisheries,
       aes(x=Year)) +
  geom_line(aes(y=Value))+
  geom_line(aes(y=predict(gam(Value~s(Year)))))


unique(livestock$Item)

```





```{r}

(aquaculture <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country=="Chile") %>%
    #filter(Species =="Atlantic salmon") %>% 
    #filter(!grepl("Inland waters", Farming_area)) %>% 
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    #filter(Year >1980) %>% 
    drop_na() %>% 
    group_by(Year) %>% 
    summarise(Value=sum(Value)) %>%
    mutate(Normalized_value = (Value - mean(Value))/sd(Value)) %>% 
    mutate(Element="Aquaculture") %>% 
    mutate(Residuals = resid(loess(Normalized_value~(Year), span=.4))) %>% 
    mutate(Variance = rollapply(data = Residuals, 
                                width= window*length(Residuals),
                                FUN = sd, 
                                align = "right", 
                                fill = NA, 
                                na.rm = T)) %>% 
    mutate(Mean = rollapply(data = Residuals, 
                            width= window*length(Residuals),
                            FUN = mean, 
                            align = "right", 
                            fill = NA, 
                            na.rm = T)) %>%
    mutate(CV=Variance/Mean) %>% 
    mutate(AR1 = rollapply(data = Residuals, 
                           width= window*length(Residuals),
                           FUN = function(z,  na.rm = FALSE){
                             return(acf(z, plot=FALSE)$acf[2])
                           },  
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>% 
    mutate(Return_rate = rollapply(data=Residuals,
                                  width= window*length(Residuals),
                                   FUN = function(z, na.rm=FALSE){
                                     ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                     return(return_rate = 1/ar1$ar[1])
                                   },
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
   mutate(Kurtosis = rollapply(data=Residuals,
                                   width=window*length(Residuals),
                                   FUN = moments::kurtosis,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T)) %>% 
    mutate(Skewness = rollapply(data=Residuals,
                                   width=0.5*length(Residuals),
                                   FUN = moments::skewness,
                                   align = "right", 
                                   fill = NA, 
                                   na.rm = T))
)


ggplot(aquaculture, 
       aes(x=Year))+
  geom_line(aes(y=Return_rate))
  #geom_line(aes(y=predict(loess(Value~Year, span=.25))))+
  #geom_vline(xintercept = 2009, linetype=2)
  



aquaculture %>% 
  filter(Species=="Whiteleg shrimp") %>% 
  drop_na(Value) %>% 
  group_by(Species, Year) %>% 
  summarise(Value=sum(Value)) %>% 
  ggplot(aes(x=Year, y=Value, colour=Species))+geom_line()+
  ggsave("test_aqua.tiff", dpi=600, device="tiff", width=10, height=4)


unique(aquaculture$Species)

```

#Trade data
```{r}
window <- 0.5

(food_bal <- fread("FoodBalanceSheets_E_All_Data_(Normalized).csv", header = TRUE) %>% 
   filter(Element %in% c("Food supply (kcal/capita/day)")) %>% 
   filter(Item %in% c("Rice (Milled Equivalent)")) %>% 
   filter(Area %in% c("Southern Asia")) %>% 
   drop_na(Value) %>% 
   group_by(Year) %>% 
   summarise(Value= sum(Value))%>% 
   mutate(Residuals = resid(loess(Value~(Year),span=0.25))) %>% 
   mutate(Variance = rollapply(data = Residuals, 
                               width =  round(window*length(Residuals)), 
                               FUN = sd, 
                               align = "right", 
                               fill = NA, 
                               na.rm = T)) %>% 
   mutate(Mean = rollapply(data = Residuals, 
                           width = round(window*length(Residuals)), 
                           FUN = mean, 
                           align = "right", 
                           fill = NA, 
                           na.rm = T)) %>%
   mutate(CV=Variance/Mean) %>%
   mutate(AR1 = rollapply(data = Residuals, 
                          width = round(window*length(Residuals)), 
                          FUN = function(z,  na.rm = FALSE){
                            return(acf(z, plot=FALSE)$acf[2])
                          },  
                          align = "right", 
                          fill = NA, 
                          na.rm = T)) %>% 
   mutate(Return_rate = rollapply(data=Residuals,
                                  width= round(window*length(Residuals)), 
                                  FUN = function(z, na.rm=FALSE){
                                    ar1 <- ar.ols(z,demean=FALSE, order.max = 1, aic = FALSE, intercept = FALSE)
                                    return(return_rate = 1/ar1$ar[1])
                                  },
                                  align = "right", 
                                  fill = NA, 
                                  na.rm = T)) %>% 
   mutate(Kurtosis = rollapply(data=Residuals,
                               width=round(window*length(Residuals)), 
                               FUN = moments::kurtosis,
                               align = "right", 
                               fill = NA, 
                               na.rm = T)) %>% 
   mutate(Skewness = rollapply(data=Residuals,
                               width=round(window*length(Residuals)), 
                               FUN = moments::skewness,
                               align = "right", 
                               fill = NA, 
                               na.rm = T))
 
)

ggplot(food_bal, aes(x=Year))+
  geom_line(aes(y=Value))+
  geom_line(aes(y=predict(gam(Value~s(Year)))))

sort(unique(food_bal$Item))
```














unique(fisheries$Country)


ggplot(fisheries, aes(Year))+
  geom_line(aes(y=(AR1)))

crops$Variance

crops_var <- (crops$Variance[28:57]-mean(crops$Variance[28:57]))/sd(crops$Variance[28:57]) 

crops_ar <- (crops$AR1[28:57]-mean(crops$AR1[28:57]))/sd(crops$AR1[28:57]) 

crops_comp <- crops_var+crops_ar



fisheries_var <- (fisheries$Variance[34:68]-mean(fisheries$Variance[34:68]))/sd(fisheries$Variance[34:68]) 

fisheries_ar <- (fisheries$AR1[34:68]-mean(fisheries$AR1[34:68]))/sd(fisheries$AR1[34:68]) 

fisheries_comp <- fisheries_var+fisheries_ar




plot(fisheries_comp, type="l")



  geom_line(aes(y=predict(loess(Value~Year, span = 0.4))))
            
            
            
              +
  geom_line(aes(y=(AR1-mean(AR1))/sd(AR1)))
  geom_vline(xintercept = 2007)


generic_ews(fisheries$Value, winsize = 50, detrending = "loess", span = 25)

plot(fisheries$Residuals/sd(fisheries$Residuals), type = "l")


sum(fisheries$Residuals/sd(fisheries$Residuals))

sum(fisheries$Residuals)

ggplot(fisheries %>% filter(Species=="Australian spiny lobster"), aes(Year, Value, colour=Species))+
  geom_line() +
  theme_pubr()+
  theme(legend.position = "bottom") +
  ggsave("test.tiff", dpi=600, device = "tiff", width=10, height = 15)




fisheries %>% filter(Year %in% c(2000,2001,2002)) %>% arrange(-Year, -Value)

```









(livestock <-
  fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
  filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
  filter(Area ==  "World") %>% 
  na.omit() %>% 
  group_by(Year) %>% 
  summarise(Value= sum(Value))%>% 
  mutate(Normalized_value = gam.func(Value, Year)) %>% 
  mutate(Element="Livestock")

)





(fisheries <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    mutate(Value = case_when(is.na(Value)~0,
                             TRUE ~ Value)) %>% 
    filter(!grepl("Inland waters", Fishing_area)) %>% 
    left_join(spp, by="Species") %>% 
    rename(Group = ISSCAAP_Group) %>%
    select(Year, Country, Group, Value) %>% 
    group_by(Country, Year) %>% 
    summarise(Value=sum(Value)) %>% 
    ungroup() %>% 
    group_by(Country) %>% 
    nest() %>% 
    mutate(Normalized_value = purrr::map(data, ~(gam.simple(.$Value, .$Year)))) %>% 
    unnest() %>% 
    mutate(Element = "Fisheries")
)

# drop_na() %>% 
#     group_by(Year) %>% 
#     summarise(Value = sum(Value)) %>% 
#     mutate(Normalized_value = gam.func(Value, Year)) %>% 
#     mutate(Element="Fisheries") %>% 
    




(aquaculture <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(!grepl("Inland waters", Farming_area)) %>% 
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na() %>% 
    group_by(Year) %>% 
    summarise(Value = sum(Value)) %>% 
    mutate(Normalized_value = gam.func(Value, Year)) %>% 
    mutate(Element="Aquaculture")
)



crops_cols <- brewer.pal(4, "Blues")
crops_cols <- colorRampPalette(crops_cols)(50)

 #"Wheat","Soybeans", "Potatoes",

ggplot(data=fisheries %>% 
         filter(Country=="Indonesia"), 
       aes(x=Year, y=Normalized_value))+
  geom_bar(stat ="identity")+
  theme_pubr()+
  scale_fill_manual(values=(crops_cols)) 
  





crops %>% 
  rename(Crops = Normalized_value) %>% 
  left_join(livestock, by="Year") %>% 
  rename(Livestock = Normalized_value) %>%
  mutate(Crops2 = lag(Crops,1)) %>% 
  drop_na() %>% 
  # select(Year, Crops, Livestock) %>% 
  # left_join(fisheries, by="Year") %>% 
  #rename(Fisheries = Normalized_value) %>% 
  # select(Year, Crops, Livestock, Fisheries) %>% 
  #left_join(aquaculture, by="Year") %>% 
  #rename(Aquaculture = Normalized_value) %>% 
  select(Crops2, Livestock) %>% 
  as.matrix() %>% 
  rcorr(type="pearson")






```




#Diversity vs. stability playing around

#screen data for quality (length and estimated proportion)
```{r}

#Livestock flags
#"F" - FAO estimate
#"" - Official data
#"Im" - FAO data based on imputation methods
#"Fc" - Calculated data 
#"*"  - Unofficial figure
#"A" - aggregate - may include official, semi-official or estimated or calculated
#"M" - data not available


#filter which countries have long time series (i.e not russia or belarus etc)

(complete_livestock_TS <-
   fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
   filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
   filter(!Area %in% c("Africa" , "Americas", "Asia", "Australia and New Zealand", "Caribbean" ,"Central America", "Central Asia" , "China","Eastern Africa", "Eastern Asia" , "Eastern Europe","Europe","European Union", "Land Locked Developing Countries", "Least Developed Countries" , "Low Income Food Deficit Countries", "Melanesia", "Micronesia", "Middle Africa", "Net Food Importing Developing Countries", "Northern Africa", "Northern America", "Northern Europe", "Oceania", "Small Island Developing States", "South-Eastern Asia", "South America", "Southern Africa" , "Southern Asia", "Southern Europe", "Western Africa","Western Asia","Western Europe", "World" )) %>% 
   na.omit() %>% 
   group_by(Area, Year) %>% 
   summarise(Value= sum(Value)) %>% 
   ungroup() %>% 
   group_by(Area) %>% 
   summarise(TS_length = length(Value)) %>% 
   filter(TS_length >40)
        
)

#OMIT countries where more than 20% of data (average per item/species) is estimated

(data_quality_livestock <-
    fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Unit=="tonnes" & Element=="Production" & !grepl("indigenous", Item)) %>% 
    filter(Area %in% complete_livestock_TS$Area) %>% 
    arrange(Area) %>%
    filter(Year>1979) %>% 
    group_by(Area, Item) %>% 
    summarise(Prop_estimate = 1-(length(Flag[Flag %in% c("","Im", "Fc", "*", "A")])/length(Flag))) %>% 
    ungroup() %>% 
    group_by(Area) %>% 
    summarise(Mean_estimate = mean(Prop_estimate)) %>%
    filter(!(Mean_estimate>0.2 & !Area %in% c("China, mainland", "Bangladesh")))
)

(livestock_countries_include <- data_quality_livestock$Area[data_quality_livestock$Area!="Polynesia"])


#Fisheries data


#Flags
## "..." = data unavailable
## " " = data not separately available
## "-" = nil or zero
## "0 0" = more than zero but less than half the unit used
## F = FAO estimate from available sources of information


#filter which countries have long time series (i.e not russia or belarus etc)
(complete_fish_ts <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>%
    mutate(Estimated = case_when(grepl(" F", Value)~ "Yes",
                                 TRUE ~ "No")) %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na() %>%
    group_by(Country, Year) %>% 
    summarise(Value = sum(Value)) %>% 
    ungroup() %>% 
    group_by(Country) %>%
    summarise(Ts_length = length(Value)) %>%
    filter(Ts_length>60)
)


#OMIT countries where more than 20% of data (average per item/species) is estimated
(data_quality_fish <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight" & Country %in% complete_fish_ts$Country) %>%
    mutate(Estimated = case_when(grepl(" F", Value)~ "Yes",
                                 TRUE ~ "No")) %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na() %>% 
    filter(Year>1979) %>% 
    group_by(Country, Species) %>% 
    summarise(Prop_estimate = length(Estimated[Estimated=="Yes"])/length(Estimated)) %>% 
    ungroup() %>% 
    group_by(Country) %>% 
    summarise(Mean_estimated = mean(Prop_estimate)) %>% 
    filter(!(Mean_estimated>0.2 & Country!="India"))
)


fisheries_countries_include <- data_quality_fish$Country






#Aquaculture data




#filter which countries have long time series (i.e not russia or belarus etc)
(complete_ts_aqua <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>%
    mutate(Estimated = case_when(grepl(" F", Value)~ "Yes",
                                 TRUE ~ "No")) %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    drop_na() %>% 
    group_by(Country, Year) %>% 
    summarise(Value = sum(Value)) %>% 
    ungroup() %>% 
    group_by(Country) %>%
    summarise(Ts_length = length(Value)) %>% 
    filter(Ts_length >40)
)

#OMIT countries where more than 20% of data (average per item/species) is estimated
(data_quality_aqua <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight" & Country %in% complete_ts_aqua$Country) %>%
    mutate(Estimated = case_when(grepl(" F", Value)~ "Yes",
                                 TRUE ~ "No")) %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>%
    filter(Year>1979) %>%
    drop_na() %>% 
    group_by(Country, Species) %>% 
    summarise(Prop_estimate = length(Estimated[Estimated=="Yes"])/length(Estimated)) %>% 
    ungroup() %>% 
    group_by(Country) %>% 
    summarise(Mean_estimated = mean(Prop_estimate)) %>% 
    filter(!(Mean_estimated>0.2 & !Country %in% c("China", "India")))
    
)


(aquaculture_countries__include <- data_quality_aqua$Country)
```

#tidy and merge production data for livestock, fisheries and aquaculture

```{r}


#Aquaculture 

#species

spp <- fread("all_spp.csv", header=TRUE) %>% 
  rename(Species = Name_en)



(aqua_prod <- 
    fread("aqua-prod-raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Farming_area = `Aquaculture area (FAO major fishing area)`,
           Environment = `Environment (Environment)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Farming_area, Environment, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>% 
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>% 
    filter(Country %in% aquaculture_countries__include) %>% 
    mutate(Species = case_when(grepl("\\[|\\]", Species) ~ gsub("\\[|\\]","", Species),
                               TRUE ~ Species)) %>% 
    na.omit() %>% 
    left_join(spp, by="Species") %>% 
    arrange(Country) %>% 
    select(Country, Species, Environment, Year, Value, Scientific_Name1, Major_Group) %>% 
    mutate(Scientific_Name1 = case_when(Species == "Hairy marron crayfish"~ "Cherax tenuimanus",
                                        is.na(Major_Group) ~ Species,
                                        TRUE~Scientific_Name1)) %>% 
    rename(Group = Major_Group) %>% 
    left_join(spp, by="Scientific_Name1") %>%
    mutate(Group = case_when(is.na(Group)~ Major_Group,
                             TRUE ~ Group)) %>% 
    select(Country, Species.x, Environment, Year, Value, Scientific_Name1, Group) %>% 
    filter(!Group %in% c("PLANTAE AQUATICAE")) %>% 
    filter(Year>1979) %>% 
    mutate(Edible_Value = case_when(Group == "PISCES" ~Value/1.15, #from Tacon and Metian 2013
                             Group == "MOLLUSCA" ~ Value/6,
                             Group =="CRUSTACEA" ~ Value /2.8,
                             TRUE ~ Value)) %>% 
    mutate(iso_code = countrycode(Country, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    rename(Item_species = Species.x) %>% 
    select(Country, iso_code, Item_species, Year, Value, Edible_Value)
)




#FISHERIES 

(fisheries_prod <- 
    fread("fisheries_prod_raw.csv", header=TRUE) %>%
    rename(Country = `Country (Country)`,
           Species = `Species (ASFIS species)`,
           Fishing_area = `Fishing area (FAO major fishing area)`,
           Unit=`Unit (Unit)`) %>% 
    gather(key="Year", value="Value", -c(Country, Species, Fishing_area, Unit)) %>%
    mutate(Year = as.numeric(Year)) %>% 
    mutate(Value = case_when(Value=="0 0" ~ "0.2",
                             Value=="-" ~ "NA",
                             Value == "..." ~ "NA",
                             Value ==" " ~ "NA",
                             TRUE ~ Value)) %>% 
    filter(Country!="Totals") %>%
    filter(Unit == "Tonnes - live weight") %>%
    mutate(Value = gsub(" F", "", Value) %>% 
             as.numeric()) %>%
    filter(Country %in% fisheries_countries_include) %>% 
    mutate(Species = case_when(grepl("\\[|\\]", Species) ~ gsub("\\[|\\]","", Species),
                               TRUE ~ Species)) %>% 
    drop_na() %>%
    left_join(spp, by="Species") %>% 
    arrange(Country) %>% 
    select(Country, Species, Fishing_area, Year, Value, Scientific_Name1, Major_Group) %>% 
    mutate(Scientific_Name1 = case_when(Species == "Diamondback terrapin"~ "Malaclemys terrapin",
                                        is.na(Major_Group) ~ Species,
                                        TRUE~Scientific_Name1)) %>% 
    rename(Group = Major_Group) %>% 
    left_join(spp, by="Scientific_Name1") %>%
    mutate(Group = case_when(is.na(Group) ~ Major_Group,
                             
                             TRUE ~ Group)) %>% 
    select(Country, Species.x, Fishing_area, Year, Value, Scientific_Name1, Group) %>% 
    mutate(Group = case_when(is.na(Group)~"CRUSTACEA",
                             TRUE ~ Group)) %>% 
    filter(!Group %in% c("PLANTAE AQUATICAE")) %>% 
    filter(Year>1979) %>% 
    mutate(Edible_Value = case_when(Group == "PISCES" ~Value/1.15, #from Tacon and Metian 2013
                             Group == "MOLLUSCA" ~ Value/6,
                             Group =="CRUSTACEA" ~ Value /2.8,
                             TRUE ~ Value)) %>% 
    mutate(iso_code = countrycode(Country, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    drop_na() %>% 
    rename(Item_species = Species.x) %>% 
    select(Country, iso_code, Item_species, Year, Value, Edible_Value) %>% 
    filter(iso_code %in% aqua_prod$iso_code)
  
)





#LIVESTOCK


omit_items <- c("Eggs Primary","Beef and Buffalo Meat","Meat, Poultry", "Beeswax", "Sheep and Goat Meat")

(livestock_prod <-
    fread("Production_LivestockPrimary_E_All_Data_(Normalized).csv", header = TRUE) %>% 
    filter(Unit=="tonnes" &
             Element=="Production" &
             !Item %in% omit_items &
             !(grepl("indigenous", Item)|grepl("Total", Item)|grepl("Hides", Item)|grepl("Skins", Item)|grepl("Wool", Item)|grepl("Hair", Item))) %>%
    filter(Area %in% livestock_countries_include) %>% 
    mutate(iso_code = countrycode(Area, origin="country.name", destination="iso3c", warn=TRUE)) %>% 
    mutate(iso_code = case_when(Area=="Eswatini" ~ "SWZ",
                                TRUE ~ iso_code)) %>% 
    rename(Country=Area,
           Item_species = Item) %>% 
    select(Country, iso_code, Item_species, Year, Value) %>% 
    mutate(Edible_Value = case_when(Item_species=="Snails, not sea"~ Value/6,
                                    TRUE ~ Value)) %>% 
    filter(Year>1979)%>% 
    filter(iso_code %in% aqua_prod$iso_code)
)  

unique(aqua_prod$iso_code) %in% unique(livestock_prod$iso_code)   
unique(fisheries_prod$Country)
unique(livestock_prod$Country)




#readjust aquaculture and fisheries nations included to account for the lowest number of nations (livestock)

aqua_prod_adj <- 
  aqua_prod %>% 
  filter(iso_code %in% livestock_prod$iso_code)

fisheries_prod_adj <- 
  fisheries_prod %>%
  filter(iso_code %in% livestock_prod$iso_code)


animal_wo_aqua <- 
  bind_rows(livestock_prod, fisheries_prod_adj)

animal_with_aqua <- 
  bind_rows(livestock_prod, fisheries_prod_adj, aqua_prod_adj) %>% 
  arrange(iso_code)

total_seafood <- 
  bind_rows(fisheries_prod_adj, aqua_prod_adj)


```

#Diversity and stability calculations variance for whole period 1980-2017 
```{r}

#Divide the biomass of item_species x in your data by the total biomass of all item_species. ...
#Multiply the fraction by its natural log (P1 * ln P1)
#Repeat this for all of the different species that you have. ...
#Sum all the - (Pi * ln Pi) products to get the value of H.



#ALL ANIMAL PRODUCTION


#Animal production Without aquaculture

(country_tots <- 
   animal_wo_aqua %>% 
   na.omit() %>% 
   group_by(iso_code) %>% 
   summarise(Country_total=sum(Edible_Value))
 
)

(national_div_no_aqua <- 
    animal_wo_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(national_var_no_aqua <- 
    animal_wo_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~(((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total))))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(no_aqua_div_var <- 
  national_div_no_aqua %>% 
  left_join(national_var_no_aqua, by="iso_code")
)

model_no_aqua <- (glm(Variance~H, data=no_aqua_div_var, family = "quasibinomial"))
summary(model_no_aqua)

fits <- predict(model_no_aqua, type = "response", se.fit = TRUE)$fit
neg_error <- fits - 1.96 *predict(model_no_aqua, type = "response", se.fit = TRUE)$se.fit
pos_error <- fits + 1.96 *predict(model_no_aqua, type = "response", se.fit = TRUE)$se.fit




no_aqua_plot <- 
  ggplot(data = no_aqua_div_var, aes(x=H))+
  geom_ribbon(aes(ymin=neg_error, ymax=pos_error), alpha=0.3, fill="dodgerblue")+
  geom_line(aes(y=fits))+
  geom_point(aes(y=Stability),colour="dodgerblue", size=.75)+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.3))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Without aquaculture")










#Animal production with aquaculture



(national_div_with_aqua <- 
    animal_with_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(national_var_with_aqua <- 
    animal_with_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~(((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total))))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Stability= sd(Prop_change))
)


(aqua_div_var <- 
  national_div_with_aqua %>% 
  left_join(national_var_with_aqua, by="iso_code")
)

model_aqua <- (glm(Variance~H, data=aqua_div_var, family = "quasibinomial"))
summary(model_aqua)

fits2 <- predict(model_aqua, type = "response", se.fit = TRUE)$fit
neg_error2 <- fits - 1.96 *predict(model_aqua, type = "response", se.fit = TRUE)$se.fit
pos_error2 <- fits + 1.96 *predict(model_aqua, type = "response", se.fit = TRUE)$se.fit



aqua_plot <- 
  ggplot(data = aqua_div_var, aes(x=H))+
  geom_ribbon(aes(ymin=neg_error2, ymax=pos_error2), alpha=0.3, fill="blue")+
  geom_line(aes(y=fits2))+
  geom_point(aes(y=Variance),colour="blue", size=.75)+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.3))+
  theme_pubr() +
  theme(text=element_text(size=7),
        axis.title.y = element_blank())+
  labs(x="Shannon-Weiner Index (H)", title = "With aquaculture")

ggarrange(no_aqua_plot, aqua_plot, nrow = 1, ncol=2, align="hv", labels = c("A", "B"), font.label = list(size=7))+
  ggsave("Supplementary Figure X.tiff", dpi=600, device="tiff", width=12, height=5, units = "cm")+
  ggsave("Supplementary Figure X.pdf", dpi=600, device="pdf", width=12, height=5, units = "cm")





(both <- bind_rows(
  no_aqua_div_var %>% 
    mutate(Element="Without aquaculture"),
  
  aqua_div_var %>% 
    mutate(Element="With aquaculture"))
)


both_plot <- 
  ggplot(data = both, aes(x=H, fill=Element))+
  geom_ribbon(aes(ymin=neg_error, ymax=pos_error), alpha=0.3, fill="blue")+
  geom_line(aes(y=fits))+
  geom_ribbon(aes(ymin=neg_error, ymax=pos_error), alpha=0.3, fill="blue")+
  geom_line(aes(y=fits2))+
  geom_point(aes(y=Variance),colour="blue", size=.75)+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.3))+
  theme_pubr() +
  theme(text=element_text(size=7),
        axis.title.y = element_blank())+
  labs(x="Shannon-Weiner Index (H)")


```

#Livestock production and aquaculture
```{r}

(livestock_tots <- 
    livestock_prod %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(livestock_div_no_aqua <- 
    livestock_prod %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(livestock_var_no_aqua <- 
    livestock_prod %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(livestock_div_var <- 
  livestock_div_no_aqua %>% 
  left_join(livestock_var_no_aqua, by="iso_code")
)

model_livestock <- (glm(Variance~H, data=livestock_div_var %>% filter(iso_code!="FRO"), family = "quasibinomial"))
summary(model_livestock)


livestock_only_plot <- 
  ggplot(data = livestock_div_var %>% filter(iso_code!="FRO"), aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_livestock, type="response")))+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.4))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Livestock - no aquaculture")




(livestock_aqua <- 
  bind_rows(livestock_prod, aqua_prod_adj) %>% 
    arrange(Country))


(livestock_aqua_tots <- 
    livestock_aqua %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(livestock_div_with_aqua <- 
    livestock_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(livestock_var_with_aqua <- 
    livestock_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(livestock_aqua_div_var <- 
  livestock_div_with_aqua %>% 
  left_join(livestock_var_with_aqua, by="iso_code")
)

model_livestock_aqua <- (glm(Variance~H, data=livestock_aqua_div_var %>% filter(iso_code!="FRO"), family = "quasibinomial"))
summary(model_livestock_aqua)
influence.measures(model_livestock_aqua)


livestock_aqua_plot <- 
  ggplot(data = livestock_aqua_div_var %>% filter(iso_code!="FRO"), aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_livestock_aqua, type="response")))+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.4))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Livestock with aquaculture")



ggarrange(livestock_only_plot, livestock_aqua_plot, nrow = 1, ncol=2, align="hv", labels = c("A", "B"), font.label = list(size=7))+
  ggsave("Supplementary Figure X2.tiff", dpi=600, device="tiff", width=12, height=5, units = "cm")+
  ggsave("Supplementary Figure X2.pdf", dpi=600, device="pdf", width=12, height=5, units = "cm")



#Fisheries and aquaculture



(fisheries_tots <- 
    fisheries_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(fisheries_div_no_aqua <- 
    fisheries_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(fisheries_var_no_aqua <- 
    fisheries_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(fisheries_div_var <- 
  fisheries_div_no_aqua %>% 
  left_join(fisheries_var_no_aqua, by="iso_code")
)

model_fisheries <- (glm(Variance~H, data=fisheries_div_var, family = "quasibinomial"))
summary(model_fisheries)


fisheries_only_plot <- 
  ggplot(data = fisheries_div_var, aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_fisheries, type="response")))+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.4))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Fisheries - no aquaculture")




(fisheries_aqua <- 
  bind_rows(fisheries_prod_adj, aqua_prod_adj) %>% 
    arrange(Country))


(fisheries_aqua_tots <- 
    fisheries_aqua %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(fisheries_div_with_aqua <- 
    fisheries_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(fisheries_var_with_aqua <- 
    fisheries_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(fisheries_aqua_div_var <- 
  fisheries_div_with_aqua %>% 
  left_join(fisheries_var_with_aqua, by="iso_code")
)

model_fisheries_aqua <- (glm(Variance~H, data=fisheries_aqua_div_var, family = "quasibinomial"))
summary(model_fisheries_aqua)



fisheries_aqua_plot <- 
  ggplot(data = fisheries_aqua_div_var, aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_fisheries_aqua, type="response", se.fit=TRUE)))+
  scale_x_continuous(limits=c(0,4))+
  scale_y_continuous(limits = c(0,0.7))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Fisheries with aquaculture")



ggarrange(fisheries_only_plot, fisheries_aqua_plot, nrow = 1, ncol=2, align="hv", labels = c("A", "B"), font.label = list(size=7))+
  ggsave("Supplementary Figure X3.tiff", dpi=600, device="tiff", width=12, height=5, units = "cm")+
  ggsave("Supplementary Figure X3.pdf", dpi=600, device="pdf", width=12, height=5, units = "cm")



#Aquaculture only
(aqua_tots <- 
    aqua_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code) %>% 
    summarise(Country_total=sum(Edible_Value))
)




(aqua_div <- 
    aqua_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(aqua_var <- 
    aqua_prod_adj %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total)))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)



(aqua_div_var <- 
  aqua_div_no_aqua %>% 
  left_join(aqua_var_no_aqua, by="iso_code")
)

model_aqua <- (glm(Variance~H, data=aqua_div_var, family = "quasibinomial"))
summary(model_aqua)

hist(aqua_div_var$Variance)


aqua_only_plot <- 
  ggplot(data = aqua_div_var, aes(x=H, y=Variance))+
  geom_point(colour="blue", size=.75)+
  geom_line(aes(y=predict(model_aqua, type="response")))+
  scale_x_continuous(limits=c(0,4))+
  #scale_y_continuous(limits = c(0,0.4))+
  theme_pubr()+ 
  theme(text=element_text(size=7))+
  labs(x="Shannon-Weiner Index (H)", y="Production variance", title = "Aquaculture only")


















```


#Change in country level variance with diversity for whole period 1980-2017
```{r}
(country_tots <- 
   animal_wo_aqua %>% 
   na.omit() %>% 
   group_by(iso_code) %>% 
   summarise(Country_total=sum(Edible_Value))
 
)

(national_div_no_aqua <- 
    animal_wo_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H_wo_aqua=sum(Pxln_P))
)


(national_var_no_aqua <- 
    animal_wo_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~(((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total))))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance_wo_aqua= sd(Prop_change))
)



(no_aqua_div_var <- 
  national_div_no_aqua %>% 
  left_join(national_var_no_aqua, by="iso_code")
)

##with aqua
(national_div_with_aqua <- 
    animal_with_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Item_species) %>% 
    summarise(Species_total = sum(Edible_Value)) %>% 
    filter(Species_total != 0) %>% 
    left_join(country_tots, by="iso_code") %>% 
    mutate(P=Species_total/Country_total,
           Pxln_P= -(P*log(P))) %>% 
    group_by(iso_code) %>% 
    summarise(H=sum(Pxln_P))
)


(national_var_with_aqua <- 
    animal_with_aqua %>% 
    na.omit() %>% 
    group_by(iso_code, Year) %>% 
    summarise(Annual_total = sum(Edible_Value)) %>% 
    group_by(iso_code) %>% 
    nest() %>% 
    mutate(Prop_change = purrr::map(data, ~(((.$Annual_total-lag(.$Annual_total))/lag(.$Annual_total))))) %>% 
    unnest() %>% 
    drop_na() %>% 
    group_by(iso_code) %>% 
    summarise(Variance= sd(Prop_change))
)


(aqua_div_var <- 
  national_div_with_aqua %>% 
  left_join(national_var_with_aqua, by="iso_code")
)

(aqua_no_aqua <- 
  left_join(no_aqua_div_var, aqua_div_var, by="iso_code") %>% 
    mutate(H_change = (H-H_wo_aqua)/H_wo_aqua, Variance_change = (Variance-Variance_wo_aqua)/Variance_wo_aqua)) 



ggplot(aqua_no_aqua, aes(x=H_change, y=Variance_change))+
  geom_point()


# model_aqua_change <- gam(Stability_change~s(H_change), data=aqua_no_aqua)
# 
# 
# ggplot(data=aqua_no_aqua , 
#        aes(x=reorder(iso_code, Stability_change), y=Stability_change))+
#   geom_bar(stat="identity")+
#   coord_flip()+
#   theme_pubr()
#   

(var_div_change <- 
    bind_rows(
      
      aqua_no_aqua %>% 
        select(iso_code, H_change) %>% 
        rename(Value=H_change) %>% 
        mutate(Element="Diversity"),
      
      aqua_no_aqua %>% 
        select(iso_code, Variance_change) %>% 
        rename(Value=Variance_change) %>%
        mutate(Element="Variance")
      
    )
)



ggplot(data = var_div_change, aes(x=reorder(iso_code, Value), y=Value, fill=Element))+
  geom_bar(stat="identity", position = "dodge")+
  coord_flip()+
  theme_pubr()



```
